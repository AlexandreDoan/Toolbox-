{% extends "base.html" %}
{% block title %}Analyse de Trafic R√©seau - Wireshark{% endblock %}
{% block content %}

<style>
    .task-card {
        border-left: 4px solid #007bff;
        margin-bottom: 20px;
    }
    .task-20 { border-left-color: #28a745; }
    .task-45 { border-left-color: #dc3545; }
    .result-box {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        max-height: 400px;
        overflow-y: auto;
    }
    .status-running { color: #007bff; }
    .status-success { color: #28a745; }
    .status-error { color: #dc3545; }
</style>
    <div class="container mt-4">
        <h1 class="text-center mb-4">üåê Analyse de Trafic R√©seau</h1>

        <!-- Navigation par onglets -->
        <ul class="nav nav-tabs" id="trafficTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pentest-tab" data-bs-toggle="tab" data-bs-target="#pentest" 
                        type="button" role="tab">
                    üîç T√¢che 20 - Capture Pentest
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="forensic-tab" data-bs-toggle="tab" data-bs-target="#forensic" 
                        type="button" role="tab">
                    üïµÔ∏è T√¢che 45 - Analyse Forensique
                </button>
            </li>
        </ul>

        <div class="tab-content" id="trafficTabContent">
            
            <!-- T√ÇCHE 20 - CAPTURE PENTEST -->
            <div class="tab-pane fade show active" id="pentest" role="tabpanel">
                <div class="card task-card task-20 mt-3">
                    <div class="card-header">
                        <h5>üîç T√¢che 20 - Int√©gration Wireshark (Tests d'intrusion)</h5>
                        <small class="text-muted">Capture le trafic r√©seau pendant vos scans</small>
                    </div>
                    <div class="card-body">
                        <form id="pentestForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Cible √† analyser</label>
                                    <input type="text" class="form-control" id="pentestTarget" 
                                           placeholder="192.168.1.1 ou example.com" required>
                                    <div class="form-text">IP ou nom de domaine √† surveiller</div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Dur√©e (secondes)</label>
                                    <select class="form-control" id="pentestDuration">
                                        <option value="30">30 secondes</option>
                                        <option value="60" selected>1 minute</option>
                                        <option value="120">2 minutes</option>
                                        <option value="300">5 minutes</option>
                                    </select>
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button type="submit" class="btn btn-success w-100">
                                        üöÄ Lancer la capture
                                    </button>
                                </div>
                            </div>
                        </form>

                        <div id="pentestStatus" class="mt-3" style="display: none;">
                            <div class="alert alert-info">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    <span id="pentestStatusText">Capture en cours...</span>
                                </div>
                                <div class="progress mt-2">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         id="pentestProgress" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <div id="pentestResults" class="result-box" style="display: none;">
                            <h6>üìä R√©sultats de la capture :</h6>
                            <div id="pentestResultsContent"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- T√ÇCHE 45 - ANALYSE FORENSIQUE -->
            <div class="tab-pane fade" id="forensic" role="tabpanel">
                <div class="card task-card task-45 mt-3">
                    <div class="card-header">
                        <h5>Analyse Forensique</h5>
                        <small class="text-muted">Analysez des fichiers PCAP existants</small>
                    </div>
                    <div class="card-body">
                        <form id="forensicForm">
                            <div class="row">
                                <div class="col-md-8">
                                    <label class="form-label">Fichier PCAP √† analyser</label>
                                    <input type="file" class="form-control" id="forensicFile" 
                                           accept=".pcap,.pcapng" required>
                                    <div class="form-text">Uploadez un fichier .pcap ou .pcapng</div>
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button type="submit" class="btn btn-danger w-100">
                                        üîç Analyser le fichier
                                    </button>
                                </div>
                            </div>
                        </form>

                        <!-- Liste des captures r√©centes (T√¢che 20) -->
                        <div class="mt-4">
                            <h6>üìÅ Captures r√©centes</h6>
                            <div id="recentCaptures" class="list-group">
                                <div class="list-group-item text-muted text-center">
                                    Aucune capture r√©cente
                                </div>
                            </div>
                        </div>

                        <div id="forensicStatus" class="mt-3" style="display: none;">
                            <div class="alert alert-warning">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    <span>Analyse forensique en cours...</span>
                                </div>
                            </div>
                        </div>

                        <div id="forensicResults" class="result-box" style="display: none;">
                            <h6>üìã Rapport d'analyse forensique :</h6>
                            <div id="forensicResultsContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let recentCaptures = [];

        // =====================================
        // T√ÇCHE 20 - CAPTURE PENTEST
        // =====================================
        document.getElementById('pentestForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const target = document.getElementById('pentestTarget').value;
            const duration = parseInt(document.getElementById('pentestDuration').value);
            
            startPentestCapture(target, duration);
        });

        function startPentestCapture(target, duration) {
            const statusDiv = document.getElementById('pentestStatus');
            const resultsDiv = document.getElementById('pentestResults');
            const statusText = document.getElementById('pentestStatusText');
            const progressBar = document.getElementById('pentestProgress');
            
            // Afficher status
            statusDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            statusText.textContent = `Capture du trafic vers ${target} pendant ${duration}s...`;
            
            // Animation progress bar
            let progress = 0;
            const interval = setInterval(() => {
                progress += (100 / duration);
                progressBar.style.width = Math.min(progress, 100) + '%';
            }, 1000);
            
            // Appel API backend
            fetch('/traffic/api/pentest-capture', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ target, duration })
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(interval);
                statusDiv.style.display = 'none';
                
                if (data.success) {
                    showPentestResults(data);
                    addRecentCapture(data);
                } else {
                    showError('pentestResults', data.error);
                }
            })
            .catch(error => {
                clearInterval(interval);
                statusDiv.style.display = 'none';
                showError('pentestResults', 'Erreur r√©seau: ' + error.message);
            });
        }

        function showPentestResults(data) {
            const resultsDiv = document.getElementById('pentestResults');
            const contentDiv = document.getElementById('pentestResultsContent');
            
            contentDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>üéØ Cible :</strong> ${data.target}<br>
                        <strong>‚è±Ô∏è Dur√©e :</strong> ${data.duration}s<br>
                        <strong>üì¶ Paquets captur√©s :</strong> ${data.packets_captured}
                    </div>
                    <div class="col-md-6">
                        <strong>üìÅ Fichier PCAP :</strong><br>
                        <code>${data.pcap_file}</code><br>
                        <button class="btn btn-sm btn-outline-primary mt-2" 
                                onclick="downloadPcap('${data.pcap_file}')">
                            üíæ T√©l√©charger PCAP
                        </button>
                    </div>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }

        // =====================================
        // T√ÇCHE 45 - ANALYSE FORENSIQUE  
        // =====================================
        document.getElementById('forensicForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('forensicFile');
            
            if (fileInput.files.length > 0) {
                startForensicAnalysis(fileInput.files[0]);
            }
        });

        function startForensicAnalysis(file) {
            const statusDiv = document.getElementById('forensicProgress');
            const resultsDiv = document.getElementById('forensicResults');
            
            statusDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            
            // Simuler progression
            let progress = 0;
            const progressBar = document.getElementById('forensicProgressBar');
            const progressText = document.getElementById('forensicProgressText');
            
            const interval = setInterval(() => {
                progress += 10;
                progressBar.style.width = progress + '%';
                
                if (progress < 50) {
                    progressText.textContent = 'Lecture du fichier PCAP...';
                } else if (progress < 80) {
                    progressText.textContent = 'Analyse des protocoles...';
                } else {
                    progressText.textContent = 'G√©n√©ration du rapport...';
                }
                
                if (progress >= 100) {
                    clearInterval(interval);
                }
            }, 200);
            
            const formData = new FormData();
            formData.append('pcap_file', file);
            
            fetch('/traffic/api/forensic-analysis', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(interval);
                statusDiv.style.display = 'none';
                
                if (data.success) {
                    showForensicResults(data);
                } else {
                    showError('forensicResults', data.error);
                }
            })
            .catch(error => {
                clearInterval(interval);
                statusDiv.style.display = 'none';
                showError('forensicResults', 'Erreur analyse: ' + error.message);
            });
        }

        function showForensicResults(data) {
            const resultsDiv = document.getElementById('forensicResults');
            const contentDiv = document.getElementById('forensicResultsContent');
            
            // Fonction pour expliquer les protocoles
            function explainProtocol(protocol, frames) {
                const explanations = {
                    'tcp': `üåê **Communication Web/Applications** (${frames} paquets)<br><small class="text-muted">Connexions vers sites web, applications, transferts de fichiers</small>`,
                    'udp': `üîç **Requ√™tes DNS/Streaming** (${frames} paquets)<br><small class="text-muted">R√©solution de noms de domaine, streaming vid√©o/audio</small>`,
                    'icmp': `üì° **Tests de Connectivit√©** (${frames} paquets)<br><small class="text-muted">Ping, diagnostic r√©seau, v√©rification d'accessibilit√©</small>`,
                    'http': `üåç **Navigation Web Non S√©curis√©e** (${frames} paquets)<br><small class="text-muted">Sites web sans chiffrement (attention aux donn√©es sensibles)</small>`,
                    'https': `üîí **Navigation Web S√©curis√©e** (${frames} paquets)<br><small class="text-muted">Sites web avec chiffrement SSL/TLS</small>`,
                    'dns': `üìû **R√©solution de Noms** (${frames} paquets)<br><small class="text-muted">Conversion nom de domaine ‚Üí adresse IP</small>`,
                    'ssh': `üîê **Connexion Administrateur** (${frames} paquets)<br><small class="text-muted">Acc√®s s√©curis√© √† distance (terminal)</small>`,
                    'ftp': `üìÅ **Transfert de Fichiers** (${frames} paquets)<br><small class="text-muted">Upload/download de documents</small>`,
                    'smtp': `üìß **Envoi d'Emails** (${frames} paquets)<br><small class="text-muted">Transmission de courrier √©lectronique</small>`,
                    'pop3': `üì¨ **R√©ception d'Emails** (${frames} paquets)<br><small class="text-muted">T√©l√©chargement des emails depuis le serveur</small>`,
                    'imap': `üìÆ **Gestion d'Emails** (${frames} paquets)<br><small class="text-muted">Synchronisation bo√Æte mail</small>`,
                    'arp': `üè† **D√©couverte R√©seau Local** (${frames} paquets)<br><small class="text-muted">Identification des appareils sur le r√©seau</small>`,
                    'dhcp': `üîß **Configuration R√©seau** (${frames} paquets)<br><small class="text-muted">Attribution automatique d'adresses IP</small>`,
                    'mdns': `üîç **D√©couverte Services** (${frames} paquets)<br><small class="text-muted">D√©tection d'imprimantes, partages r√©seau</small>`
                };
                
                return explanations[protocol.toLowerCase()] || 
                       `üîß **Protocole ${protocol.toUpperCase()}** (${frames} paquets)<br><small class="text-muted">Trafic r√©seau sp√©cialis√©</small>`;
            }
            
            // Fonction pour expliquer les conversations
            function explainConversation(endpoints, packets, bytes) {
                const [src, dst] = endpoints.split(' <-> ');
                
                // Analyser le type de communication
                if (dst.includes('8.8.8.8') || dst.includes('8.8.4.4')) {
                    return `üåê **Requ√™tes DNS vers Google** (${packets} √©changes)<br><small class="text-muted">R√©solution de noms de domaine via serveurs Google DNS</small>`;
                } else if (dst.includes('1.1.1.1') || dst.includes('1.0.0.1')) {
                    return `üåê **Requ√™tes DNS vers Cloudflare** (${packets} √©changes)<br><small class="text-muted">R√©solution de noms de domaine via serveurs Cloudflare</small>`;
                } else if (src.startsWith('172.20') && dst.startsWith('172.20')) {
                    return `üè† **Communication Interne** (${packets} √©changes)<br><small class="text-muted">Trafic entre conteneurs Docker de la toolbox</small>`;
                } else if (src.startsWith('192.168') && dst.startsWith('192.168')) {
                    return `üè† **R√©seau Local** (${packets} √©changes)<br><small class="text-muted">Communication entre appareils du r√©seau domestique/entreprise</small>`;
                } else if (dst.includes(':443') || src.includes(':443')) {
                    return `üîí **Connexion HTTPS** (${packets} √©changes)<br><small class="text-muted">Navigation s√©curis√©e ou API chiffr√©e</small>`;
                } else if (dst.includes(':80') || src.includes(':80')) {
                    return `üåç **Connexion HTTP** (${packets} √©changes)<br><small class="text-muted">Navigation web non chiffr√©e</small>`;
                } else if (dst.includes(':22') || src.includes(':22')) {
                    return `üîê **Connexion SSH** (${packets} √©changes)<br><small class="text-muted">Administration √† distance s√©curis√©e</small>`;
                } else if (dst.includes(':53') || src.includes(':53')) {
                    return `üìû **Requ√™te DNS** (${packets} √©changes)<br><small class="text-muted">R√©solution de nom de domaine</small>`;
                } else {
                    return `üîó **Communication R√©seau** (${packets} √©changes)<br><small class="text-muted">Entre ${src} et ${dst}</small>`;
                }
            }
            
            // G√©n√©rer le HTML des protocoles avec explications
            let protocolsHtml = '';
            if (data.protocols && data.protocols.length > 0) {
                protocolsHtml = data.protocols.map(p => `
                    <div class="alert alert-light border-start border-primary border-3 py-2 mb-2">
                        ${explainProtocol(p.protocol, p.frames)}
                    </div>
                `).join('');
            }
            
            // G√©n√©rer le HTML des conversations avec explications
            let conversationsHtml = '';
            if (data.conversations && data.conversations.length > 0) {
                conversationsHtml = data.conversations.map(c => `
                    <div class="card mb-2">
                        <div class="card-body py-2">
                            ${explainConversation(c.endpoints, c.packets, c.bytes)}
                            <div class="mt-1">
                                <span class="badge bg-secondary">${c.bytes} bytes</span>
                                <span class="badge bg-info">${c.packets} paquets</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            // G√©n√©rer le rapport complet
            contentDiv.innerHTML = `
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">üìä Rapport d'Analyse Forensique - Compr√©hensible</h5>
                    </div>
                    <div class="card-body">
                        <!-- R√©sum√© ex√©cutif -->
                        <div class="alert alert-info mb-4">
                            <h6 class="alert-heading">üìã R√©sum√© de l'Analyse</h6>
                            <p class="mb-1">
                                <strong>Total paquets :</strong> ${data.general_info?.total_packets || 'N/A'} |
                                <strong>Dur√©e :</strong> ${data.general_info?.duration || 'N/A'} |
                                <strong>Taille :</strong> ${data.general_info?.file_size || 'N/A'}
                            </p>
                            <p class="mb-0">
                                <strong>Types d'activit√© d√©tect√©s :</strong> ${data.protocols?.length || 0} protocoles diff√©rents, 
                                ${data.conversations?.length || 0} conversations r√©seau principales
                            </p>
                        </div>
                        
                        <!-- Activit√©s d√©tect√©es -->
                        <div class="mb-4">
                            <h6 class="text-primary mb-3">üîç Activit√©s R√©seau D√©tect√©es</h6>
                            ${protocolsHtml || '<div class="alert alert-warning">Aucune activit√© r√©seau d√©tect√©e</div>'}
                        </div>
                        
                        <!-- Communications principales -->
                        <div class="mb-4">
                            <h6 class="text-success mb-3">üí¨ Communications Principales</h6>
                            ${conversationsHtml || '<div class="alert alert-warning">Aucune communication d√©tect√©e</div>'}
                        </div>
                        
                        <!-- Actions -->
                        <div class="d-flex gap-2 mt-4">
                            <button class="btn btn-primary btn-sm" onclick="downloadPcap('${data.pcap_file}')">
                                üíæ T√©l√©charger PCAP Original
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="exportForensicReport()">
                                üìÑ Exporter ce Rapport
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }

        // =====================================
        // FONCTIONS UTILITAIRES
        // =====================================
        function showError(containerId, errorMsg) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="alert alert-danger">
                    <strong>‚ùå Erreur :</strong> ${errorMsg}
                </div>
            `;
            container.style.display = 'block';
        }


        function exportForensicReport() {
            // R√©cup√©rer le contenu du rapport
            const reportContent = document.getElementById('forensicResultsContent').innerText;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            
            // Cr√©er le contenu du rapport
            const reportText = `
        RAPPORT D'ANALYSE FORENSIQUE - ${new Date().toLocaleString()}
        ================================================================
        
        ${reportContent}
        
        --- Informations techniques ---
        G√©n√©r√© par : Toolbox Cybers√©curit√© - Module Wireshark
        Date : ${new Date().toLocaleString()}
            `.trim();
            
            // T√©l√©charger comme fichier texte
            const blob = new Blob([reportText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rapport-forensique-${timestamp}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function addRecentCapture(captureData) {
            recentCaptures.unshift({
                target: captureData.target,
                file: captureData.pcap_file,
                packets: captureData.packets_captured,
                timestamp: new Date().toLocaleString()
            });
            
            // Garder max 5 captures
            recentCaptures = recentCaptures.slice(0, 5);
            updateRecentCapturesList();
        }

        function updateRecentCapturesList() {
            const container = document.getElementById('recentCaptures');
            
            if (recentCaptures.length === 0) {
                container.innerHTML = '<div class="list-group-item text-muted text-center">Aucune capture r√©cente</div>';
                return;
            }
            
            container.innerHTML = recentCaptures.map(capture => `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${capture.target}</strong><br>
                        <small class="text-muted">${capture.timestamp} - ${capture.packets} paquets</small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" 
                            onclick="analyzeRecentCapture('${capture.file}')">
                        üîç Analyser
                    </button>
                </div>
            `).join('');
        }

        function analyzeRecentCapture(pcapFile) {
            document.getElementById('forensic-tab').click();
            
            fetch('/traffic/api/forensic-analysis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pcap_file: pcapFile })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showForensicResults(data);
                } else {
                    showError('forensicResults', data.error);
                }
            });
        }

        function downloadPcap(pcapFile) {
            const filename = pcapFile.includes('/') ? pcapFile.split('/').pop() : pcapFile;
            window.open(`/traffic/api/download/${encodeURIComponent(filename)}`);
        }
    </script>
</body>
</html>
