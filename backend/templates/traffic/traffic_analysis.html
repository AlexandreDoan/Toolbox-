<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse de Trafic R√©seau - T√¢ches 20 & 45</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .task-card {
            border-left: 4px solid #007bff;
            margin-bottom: 20px;
        }
        .task-20 { border-left-color: #28a745; }
        .task-45 { border-left-color: #dc3545; }
        .result-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-running { color: #007bff; }
        .status-success { color: #28a745; }
        .status-error { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">üåê Analyse de Trafic R√©seau</h1>
        <p class="text-center text-muted mb-5">T√¢ches 20 (Tests d'intrusion) & 45 (Analyse forensique)</p>

        <!-- Navigation par onglets -->
        <ul class="nav nav-tabs" id="trafficTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pentest-tab" data-bs-toggle="tab" data-bs-target="#pentest" 
                        type="button" role="tab">
                    üîç T√¢che 20 - Capture Pentest
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="forensic-tab" data-bs-toggle="tab" data-bs-target="#forensic" 
                        type="button" role="tab">
                    üïµÔ∏è T√¢che 45 - Analyse Forensique
                </button>
            </li>
        </ul>

        <div class="tab-content" id="trafficTabContent">
            
            <!-- T√ÇCHE 20 - CAPTURE PENTEST -->
            <div class="tab-pane fade show active" id="pentest" role="tabpanel">
                <div class="card task-card task-20 mt-3">
                    <div class="card-header">
                        <h5>üîç T√¢che 20 - Int√©gration Wireshark (Tests d'intrusion)</h5>
                        <small class="text-muted">Capture le trafic r√©seau pendant vos scans</small>
                    </div>
                    <div class="card-body">
                        <form id="pentestForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Cible √† analyser</label>
                                    <input type="text" class="form-control" id="pentestTarget" 
                                           placeholder="192.168.1.1 ou example.com" required>
                                    <div class="form-text">IP ou nom de domaine √† surveiller</div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Dur√©e (secondes)</label>
                                    <select class="form-control" id="pentestDuration">
                                        <option value="30">30 secondes</option>
                                        <option value="60" selected>1 minute</option>
                                        <option value="120">2 minutes</option>
                                        <option value="300">5 minutes</option>
                                    </select>
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button type="submit" class="btn btn-success w-100">
                                        üöÄ Lancer la capture
                                    </button>
                                </div>
                            </div>
                        </form>

                        <div id="pentestStatus" class="mt-3" style="display: none;">
                            <div class="alert alert-info">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    <span id="pentestStatusText">Capture en cours...</span>
                                </div>
                                <div class="progress mt-2">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         id="pentestProgress" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <div id="pentestResults" class="result-box" style="display: none;">
                            <h6>üìä R√©sultats de la capture :</h6>
                            <div id="pentestResultsContent"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- T√ÇCHE 45 - ANALYSE FORENSIQUE -->
            <div class="tab-pane fade" id="forensic" role="tabpanel">
                <div class="card task-card task-45 mt-3">
                    <div class="card-header">
                        <h5>üïµÔ∏è T√¢che 45 - Analyse Forensique</h5>
                        <small class="text-muted">Analysez des fichiers PCAP existants</small>
                    </div>
                    <div class="card-body">
                        <form id="forensicForm">
                            <div class="row">
                                <div class="col-md-8">
                                    <label class="form-label">Fichier PCAP √† analyser</label>
                                    <input type="file" class="form-control" id="forensicFile" 
                                           accept=".pcap,.pcapng" required>
                                    <div class="form-text">Uploadez un fichier .pcap ou .pcapng</div>
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button type="submit" class="btn btn-danger w-100">
                                        üîç Analyser le fichier
                                    </button>
                                </div>
                            </div>
                        </form>

                        <!-- Liste des captures r√©centes (T√¢che 20) -->
                        <div class="mt-4">
                            <h6>üìÅ Captures r√©centes (depuis T√¢che 20)</h6>
                            <div id="recentCaptures" class="list-group">
                                <div class="list-group-item text-muted text-center">
                                    Aucune capture r√©cente
                                </div>
                            </div>
                        </div>

                        <div id="forensicStatus" class="mt-3" style="display: none;">
                            <div class="alert alert-warning">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    <span>Analyse forensique en cours...</span>
                                </div>
                            </div>
                        </div>

                        <div id="forensicResults" class="result-box" style="display: none;">
                            <h6>üìã Rapport d'analyse forensique :</h6>
                            <div id="forensicResultsContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let recentCaptures = [];

        // =====================================
        // T√ÇCHE 20 - CAPTURE PENTEST
        // =====================================
        document.getElementById('pentestForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const target = document.getElementById('pentestTarget').value;
            const duration = parseInt(document.getElementById('pentestDuration').value);
            
            startPentestCapture(target, duration);
        });

        function startPentestCapture(target, duration) {
            const statusDiv = document.getElementById('pentestStatus');
            const resultsDiv = document.getElementById('pentestResults');
            const statusText = document.getElementById('pentestStatusText');
            const progressBar = document.getElementById('pentestProgress');
            
            // Afficher status
            statusDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            statusText.textContent = `Capture du trafic vers ${target} pendant ${duration}s...`;
            
            // Animation progress bar
            let progress = 0;
            const interval = setInterval(() => {
                progress += (100 / duration);
                progressBar.style.width = Math.min(progress, 100) + '%';
            }, 1000);
            
            // Appel API backend
            fetch('/traffic/api/pentest-capture', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ target, duration })
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(interval);
                statusDiv.style.display = 'none';
                
                if (data.success) {
                    showPentestResults(data);
                    addRecentCapture(data);
                } else {
                    showError('pentestResults', data.error);
                }
            })
            .catch(error => {
                clearInterval(interval);
                statusDiv.style.display = 'none';
                showError('pentestResults', 'Erreur r√©seau: ' + error.message);
            });
        }

        function showPentestResults(data) {
            const resultsDiv = document.getElementById('pentestResults');
            const contentDiv = document.getElementById('pentestResultsContent');
            
            contentDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>üéØ Cible :</strong> ${data.target}<br>
                        <strong>‚è±Ô∏è Dur√©e :</strong> ${data.duration}s<br>
                        <strong>üì¶ Paquets captur√©s :</strong> ${data.packets_captured}
                    </div>
                    <div class="col-md-6">
                        <strong>üìÅ Fichier PCAP :</strong><br>
                        <code>${data.pcap_file}</code><br>
                        <button class="btn btn-sm btn-outline-primary mt-2" 
                                onclick="downloadPcap('${data.pcap_file}')">
                            üíæ T√©l√©charger PCAP
                        </button>
                    </div>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }

        // =====================================
        // T√ÇCHE 45 - ANALYSE FORENSIQUE  
        // =====================================
        document.getElementById('forensicForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('forensicFile');
            
            if (fileInput.files.length > 0) {
                startForensicAnalysis(fileInput.files[0]);
            }
        });

        function startForensicAnalysis(file) {
            const statusDiv = document.getElementById('forensicStatus');
            const resultsDiv = document.getElementById('forensicResults');
            
            statusDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            
            const formData = new FormData();
            formData.append('pcap_file', file);
            
            fetch('/api/traffic/forensic-analysis', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                statusDiv.style.display = 'none';
                
                if (data.success) {
                    showForensicResults(data);
                } else {
                    showError('forensicResults', data.error);
                }
            })
            .catch(error => {
                statusDiv.style.display = 'none';
                showError('forensicResults', 'Erreur analyse: ' + error.message);
            });
        }

        function showForensicResults(data) {
            const resultsDiv = document.getElementById('forensicResults');
            const contentDiv = document.getElementById('forensicResultsContent');
            
            let protocolsHtml = '';
            if (data.protocols && data.protocols.length > 0) {
                protocolsHtml = data.protocols.map(p => 
                    `<span class="badge bg-secondary me-1">${p.protocol} (${p.frames})</span>`
                ).join('');
            }
            
            let conversationsHtml = '';
            if (data.conversations && data.conversations.length > 0) {
                conversationsHtml = data.conversations.map(c => 
                    `<li><code>${c.endpoints}</code> - ${c.packets} paquets, ${c.bytes} bytes</li>`
                ).join('');
            }
            
            contentDiv.innerHTML = `
                <div class="row">
                    <div class="col-12">
                        <h6>üìä Informations g√©n√©rales :</h6>
                        <ul>
                            <li><strong>Paquets totaux :</strong> ${data.general_info.total_packets || 'N/A'}</li>
                            <li><strong>Taille fichier :</strong> ${data.general_info.file_size || 'N/A'}</li>
                            <li><strong>Taille donn√©es :</strong> ${data.general_info.data_size || 'N/A'}</li>
                        </ul>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h6>üîå Protocoles d√©tect√©s :</h6>
                        ${protocolsHtml || '<em class="text-muted">Aucun protocole d√©tect√©</em>'}
                    </div>
                    <div class="col-md-6">
                        <h6>üí¨ Conversations principales :</h6>
                        ${conversationsHtml ? `<ul>${conversationsHtml}</ul>` : '<em class="text-muted">Aucune conversation d√©tect√©e</em>'}
                    </div>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }

        // =====================================
        // FONCTIONS UTILITAIRES
        // =====================================
        function showError(containerId, errorMsg) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="alert alert-danger">
                    <strong>‚ùå Erreur :</strong> ${errorMsg}
                </div>
            `;
            container.style.display = 'block';
        }

        function addRecentCapture(captureData) {
            recentCaptures.unshift({
                target: captureData.target,
                file: captureData.pcap_file,
                packets: captureData.packets_captured,
                timestamp: new Date().toLocaleString()
            });
            
            // Garder max 5 captures
            recentCaptures = recentCaptures.slice(0, 5);
            updateRecentCapturesList();
        }

        function updateRecentCapturesList() {
            const container = document.getElementById('recentCaptures');
            
            if (recentCaptures.length === 0) {
                container.innerHTML = '<div class="list-group-item text-muted text-center">Aucune capture r√©cente</div>';
                return;
            }
            
            container.innerHTML = recentCaptures.map(capture => `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${capture.target}</strong><br>
                        <small class="text-muted">${capture.timestamp} - ${capture.packets} paquets</small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" 
                            onclick="analyzeRecentCapture('${capture.file}')">
                        üîç Analyser
                    </button>
                </div>
            `).join('');
        }

        function analyzeRecentCapture(pcapFile) {
            document.getElementById('forensic-tab').click();
            
            fetch('/api/traffic/forensic-analysis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pcap_file: pcapFile })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showForensicResults(data);
                } else {
                    showError('forensicResults', data.error);
                }
            });
        }

        function downloadPcap(pcapFile) {
            window.open(`/api/traffic/download/${encodeURIComponent(pcapFile)}`);
        }
    </script>
</body>
</html>
