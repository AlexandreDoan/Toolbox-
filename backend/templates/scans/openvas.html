{% extends "base.html" %}
{% block title %}Scanner OpenVAS{% endblock %}
{% block content %}

<h2>🔍 Scanner de vulnérabilités OpenVAS</h2>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for cat, msg in messages %}
      <div class="alert alert-{{ cat }}">{{ msg }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- Formulaire de lancement -->
<div class="card mb-4">
  <div class="card-header">
    <h5>🚀 Lancer un nouveau scan</h5>
  </div>
  <div class="card-body">
    <form method="post">
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="target" class="form-label">Adresse IP cible</label>
          <input type="text" class="form-control" id="target" name="target" 
                 placeholder="ex : 192.168.1.10, dvwa, 192.168.1.0/24" required
                 pattern="^(((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(/[0-9]{1,2})?|[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?)*)$"
                 title="Format valide : IP (192.168.1.10), plage CIDR (192.168.1.0/24) ou hostname (dvwa, example.com)">
          <div class="form-text">
            <small>Formats acceptés : IP (192.168.1.10), plage CIDR (192.168.1.0/24), hostname (dvwa)</small>
          </div>
        </div>
        <div class="col-md-6">
          <label for="scan_name" class="form-label">Nom du scan</label>
          <input type="text" class="form-control" id="scan_name" name="scan_name" 
                 placeholder="Mon scan">
        </div>
      </div>
      
      <div class="row mb-3">
        <div class="col-md-12">
          <label for="scan_type" class="form-label">Type de scan</label>
          <select class="form-select" id="scan_type" name="scan_type" required>
            <option value="full_and_fast" selected>🚀 Standard (Full and fast) - 15-30 min</option>
            <option value="discovery">🔍 Rapide (Discovery) - 5-10 min</option>
            <option value="full_and_very_deep">🔬 Complet (Full and very deep) - 45-90 min</option>
            <option value="system_discovery">💻 Système (System Discovery) - 10-20 min</option>
            <option value="host_discovery">📡 Hôtes (Host Discovery) - 2-5 min</option>
          </select>
        </div>
      </div>
      
      <div class="d-grid gap-2 d-md-flex">
        <button type="submit" class="btn btn-danger btn-lg">
          🚀 Lancer le scan
        </button>
        <a href="https://localhost:9392" target="_blank" class="btn btn-outline-secondary">
          🌐 Interface OpenVAS
        </a>
      </div>
    </form>
  </div>
</div>

<!-- Monitoring des scans actifs -->
{% if active_scans %}
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5>📊 Scans en cours</h5>
    <button class="btn btn-sm btn-outline-primary" onclick="refreshScans()">
      🔄 Actualiser
    </button>
  </div>
  <div class="card-body" id="active-scans">
    {% for scan in active_scans %}
    <div class="scan-item mb-3 p-3 border rounded" data-scan-id="{{ scan.id }}">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <strong>🎯 {{ scan.scan_name }}</strong>
          <span class="text-muted">→ {{ scan.target_ip }}</span>
          <span class="badge bg-info">{{ scan.scan_type }}</span>
        </div>
        <div class="d-flex gap-2 align-items-center">
          <!-- ✅ BOUTONS TOUJOURS PRÉSENTS -->
          <button class="btn btn-sm btn-warning pause-btn" 
                  data-task-id="{{ scan.task_id }}" 
                  data-scan-id="{{ scan.id }}"
                  onclick="pauseScan('{{ scan.task_id }}', {{ scan.id }})">
            ⏸️ Pause
          </button>
          
          <button class="btn btn-sm btn-success resume-btn" 
                  data-task-id="{{ scan.task_id }}" 
                  data-scan-id="{{ scan.id }}"
                  onclick="resumeScan('{{ scan.task_id }}', {{ scan.id }})">
            ▶️ Reprendre
          </button>
          
          <button class="btn btn-sm btn-danger" onclick="deleteScanDisplay({{ scan.id }})">
            🗑️ Supprimer
          </button>
          
          <div class="text-end">
            <small class="text-muted">{{ scan.started_at }}</small><br>
            <span class="badge bg-{{ 'success' if scan.status == 'Terminé' else 'warning' if scan.status == 'En cours' else 'secondary' }}" 
                  data-scan-id="{{ scan.id }}-status">
              {{ scan.status }}
            </span>
          </div>
        </div>
      </div>
      
      <!-- Barre de progression -->
      <div class="progress mb-2" style="height: 25px;">
        <div class="progress-bar progress-bar-striped 
                    {% if scan.status == 'En cours' %}progress-bar-animated bg-warning{% elif scan.status == 'Terminé' %}bg-success{% else %}bg-info{% endif %}" 
             role="progressbar" 
             style="width: {{ scan.progress }}%"
             data-progress="{{ scan.progress }}">
          {{ scan.progress }}%
        </div>
      </div>
      
      <div class="d-flex justify-content-between align-items-center">
        <small class="text-muted">
          ⏱️ Durée estimée: {{ scan.estimated_duration }}
        </small>
        {% if scan.status == 'Terminé' %}
        <button class="btn btn-sm btn-success" onclick="viewResults('{{ scan.task_id }}', '{{ scan.scan_name }}')">
          📋 Voir résultats
        </button>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- Historique des scans avec pagination -->
{% if all_scans %}
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5>📋 Historique des scans</h5>
    
    <!-- Sélecteur de pagination -->
    <div class="d-flex align-items-center gap-2">
      <label class="form-label mb-0">Afficher:</label>
      <select class="form-select form-select-sm" style="width: auto;" onchange="changePagination(this.value)">
        <option value="5" {% if current_limit == 5 %}selected{% endif %}>5 scans</option>
        <option value="10" {% if current_limit == 10 %}selected{% endif %}>10 scans</option>
        <option value="50" {% if current_limit == 50 %}selected{% endif %}>50 scans</option>
        <option value="all" {% if current_limit is none %}selected{% endif %}>Tous</option>
      </select>
    </div>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Cible</th>
            <th>Type</th>
            <th>Status</th>
            <th>Progression</th>
            <th>Démarré</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for scan in all_scans %}
          <tr data-scan-id="{{ scan.id }}">
            <td><strong>{{ scan.scan_name }}</strong></td>
            <td>{{ scan.target_ip }}</td>
            <td><span class="badge bg-light text-dark">{{ scan.scan_type }}</span></td>
            <td>
              <span class="badge bg-{{ 'success' if scan.status == 'Terminé' else 'warning' if scan.status == 'En cours' else 'secondary' }}" 
                    data-scan-id="{{ scan.id }}-status">
                {{ scan.status }}
              </span>
            </td>
            <td>{{ scan.progress }}%</td>
            <td><small>{{ scan.started_at }}</small></td>
            <td>
              <div class="btn-group btn-group-sm">
                <!-- ✅ BOUTONS TOUJOURS PRÉSENTS DANS LE TABLEAU AUSSI -->
                <button class="btn btn-outline-warning pause-btn" 
                        data-task-id="{{ scan.task_id }}" 
                        data-scan-id="{{ scan.id }}"
                        onclick="pauseScan('{{ scan.task_id }}', {{ scan.id }})" 
                        title="Mettre en pause">
                  ⏸️
                </button>
                
                <button class="btn btn-outline-success resume-btn" 
                        data-task-id="{{ scan.task_id }}" 
                        data-scan-id="{{ scan.id }}"
                        onclick="resumeScan('{{ scan.task_id }}', {{ scan.id }})" 
                        title="Reprendre">
                  ▶️
                </button>
                
                {% if scan.status == 'Terminé' %}
                <button class="btn btn-outline-primary" onclick="viewResults('{{ scan.task_id }}', '{{ scan.scan_name }}')">
                  📄 Résultats
                </button>
                {% endif %}
                
                <button class="btn btn-outline-warning" onclick="deleteScanDisplay({{ scan.id }})" title="Supprimer de l'affichage">
                  👁️‍🗨️
                </button>
                
                <button class="btn btn-outline-danger" onclick="deleteOpenVASTask('{{ scan.task_id }}', {{ scan.id }})" title="Supprimer de OpenVAS">
                  🗑️
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

<!-- Modal pour afficher les résultats -->
<div class="modal fade" id="resultsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">📋 Résultats du scan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="scan-results">
          <div class="text-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Chargement...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Auto-refresh des scans toutes les 15 secondes
let refreshInterval;

function startAutoRefresh() {
    refreshInterval = setInterval(refreshScans, 15000);
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
}

function updateScanProgress(scans) {
    scans.forEach(scan => {
        const scanElement = document.querySelector(`[data-scan-id="${scan.id}"]`);
        if (scanElement) {
            // ✅ MISE À JOUR DE LA BARRE DE PROGRESSION
            const progressBar = scanElement.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.width = scan.progress + '%';
                progressBar.textContent = scan.progress + '%';
                
                // Mettre à jour les classes CSS selon le statut
                progressBar.className = 'progress-bar progress-bar-striped';
                if (scan.status === 'En cours') {
                    progressBar.classList.add('progress-bar-animated', 'bg-warning');
                } else if (scan.status === 'Terminé') {
                    progressBar.classList.add('bg-success');
                } else {
                    progressBar.classList.add('bg-info');
                }
            }
            
            // ✅ MISE À JOUR DU BADGE DE STATUT SEULEMENT
            const statusBadge = scanElement.querySelector(`[data-scan-id="${scan.id}-status"]`) || 
                               scanElement.querySelector('.badge');
            if (statusBadge) {
                statusBadge.textContent = scan.status;
                statusBadge.className = 'badge';
                if (scan.status === 'Terminé') {
                    statusBadge.classList.add('bg-success');
                } else if (scan.status === 'En cours') {
                    statusBadge.classList.add('bg-warning');
                } else if (scan.status === 'Arrêté') {
                    statusBadge.classList.add('bg-secondary');
                } else {
                    statusBadge.classList.add('bg-info');
                }
            }
            
            // ✅ MISE À JOUR DE L'ÉTAT DES BOUTONS (pas suppression)
            updateButtonStates(scan);
        }
    });
}

// ✅ NOUVELLE FONCTION : Met à jour l'état des boutons sans les supprimer
function updateButtonStates(scan) {
    const pauseButtons = document.querySelectorAll(`[data-task-id="${scan.task_id}"].pause-btn`);
    const resumeButtons = document.querySelectorAll(`[data-task-id="${scan.task_id}"].resume-btn`);
    
    pauseButtons.forEach(btn => {
        if (scan.status === 'En cours' || scan.status === 'Running') {
            btn.disabled = false;
            btn.classList.remove('btn-secondary');
            btn.classList.add('btn-warning');
            btn.style.opacity = '1';
        } else {
            btn.disabled = true;
            btn.classList.remove('btn-warning');
            btn.classList.add('btn-secondary');
            btn.style.opacity = '0.5';
        }
    });
    
    resumeButtons.forEach(btn => {
        if (scan.status === 'Arrêté' || scan.status === 'Stopped') {
            btn.disabled = false;
            btn.classList.remove('btn-secondary');
            btn.classList.add('btn-success');
            btn.style.opacity = '1';
        } else {
            btn.disabled = true;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-secondary');
            btn.style.opacity = '0.5';
        }
    });
}

function refreshScans() {
    fetch('/openvas/status')
    .then(response => response.json())
    .then(data => {
        updateScanProgress(data.scans);
    })
    .catch(error => {
        console.error('Erreur refresh:', error);
    });
}

// ✅ FONCTIONS PAUSE/REPRISE SIMPLIFIÉES
function pauseScan(taskId, scanId) {
    const button = event.target;
    const originalContent = button.innerHTML;
    const originalClass = button.className;
    
    // Feedback visuel temporaire
    button.innerHTML = '🔄 Arrêt...';
    button.disabled = true;
    
    fetch(`/openvas/pause/${taskId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('✅ Scan en cours d\'arrêt', 'success');
            
            // Attendre 3 secondes puis restaurer le bouton et actualiser
            setTimeout(() => {
                button.innerHTML = originalContent;
                button.className = originalClass;
                refreshScans(); // Actualiser pour voir le nouveau statut
            }, 3000);
        } else {
            showNotification('❌ Erreur: ' + data.message, 'error');
            button.innerHTML = originalContent;
            button.className = originalClass;
            button.disabled = false;
        }
    })
    .catch(error => {
        showNotification('❌ Erreur réseau: ' + error, 'error');
        button.innerHTML = originalContent;
        button.className = originalClass;
        button.disabled = false;
    });
}

function resumeScan(taskId, scanId) {
    const button = event.target;
    const originalContent = button.innerHTML;
    const originalClass = button.className;
    
    // Feedback visuel temporaire
    button.innerHTML = '🔄 Reprise...';
    button.disabled = true;
    
    fetch(`/openvas/resume/${taskId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('✅ Scan en cours de reprise', 'success');
            
            // Attendre 3 secondes puis restaurer le bouton et actualiser
            setTimeout(() => {
                button.innerHTML = originalContent;
                button.className = originalClass;
                refreshScans(); // Actualiser pour voir le nouveau statut
            }, 3000);
        } else {
            showNotification('❌ Erreur: ' + data.message, 'error');
            button.innerHTML = originalContent;
            button.className = originalClass;
            button.disabled = false;
        }
    })
    .catch(error => {
        showNotification('❌ Erreur réseau: ' + error, 'error');
        button.innerHTML = originalContent;
        button.className = originalClass;
        button.disabled = false;
    });
}

function deleteScanDisplay(scanId) {
    fetch(`/openvas/delete/${scanId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Supprimer visuellement l'élément
            const scanElement = document.querySelector(`[data-scan-id="${scanId}"]`);
            if (scanElement) {
                // Animation de disparition
                scanElement.style.transition = 'opacity 0.3s';
                scanElement.style.opacity = '0';
                setTimeout(() => {
                    scanElement.remove();
                }, 300);
            }
            
            // Notification visuelle discrète
            showNotification('✅ Scan supprimé de l\'affichage', 'success');
        } else {
            showNotification('❌ Erreur: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showNotification('❌ Erreur réseau: ' + error, 'error');
    });
}

function deleteOpenVASTask(taskId, scanId) {
    if (!confirm('⚠️ ATTENTION !\n\nCeci va supprimer DÉFINITIVEMENT la tâche de OpenVAS/Greenbone.\nLes résultats seront perdus à jamais.\n\nÊtes-vous sûr ?')) {
        return;
    }
    
    // Trouver le bouton pour feedback visuel
    const button = event.target;
    const originalContent = button.innerHTML;
    const originalClass = button.className;
    
    // Feedback visuel
    button.innerHTML = '🔄';
    button.disabled = true;
    button.className = 'btn btn-sm btn-secondary';
    
    fetch(`/openvas/delete_task/${taskId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('✅ Tâche supprimée de OpenVAS définitivement', 'success');
            
            // Supprimer visuellement la ligne du tableau
            const scanRow = button.closest('tr');
            if (scanRow) {
                scanRow.style.transition = 'opacity 0.5s';
                scanRow.style.opacity = '0';
                setTimeout(() => {
                    scanRow.remove();
                }, 500);
            }
        } else {
            showNotification('❌ Erreur: ' + data.message, 'error');
            
            // Restaurer le bouton
            button.innerHTML = originalContent;
            button.className = originalClass;
            button.disabled = false;
        }
    })
    .catch(error => {
        showNotification('❌ Erreur réseau: ' + error, 'error');
        
        // Restaurer le bouton
        button.innerHTML = originalContent;
        button.className = originalClass;
        button.disabled = false;
    });
}

// Fonction pour les notifications visuelles
function showNotification(message, type = 'info') {
    // Créer la notification
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
    notification.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        animation: slideIn 0.3s ease-out;
    `;
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close float-end" onclick="this.parentElement.remove()"></button>
    `;
    
    // Ajouter au DOM
    document.body.appendChild(notification);
    
    // Supprimer automatiquement après 3 secondes
    setTimeout(() => {
        if (notification.parentElement) {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => notification.remove(), 300);
        }
    }, 3000);
}

// Ajouter les animations CSS
if (!document.getElementById('notification-styles')) {
    const style = document.createElement('style');
    style.id = 'notification-styles';
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
}

function changePagination(limit) {
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('limit', limit);
    window.location.href = currentUrl.toString();
}

// Dans votre openvas.html, REMPLACER la section d'affichage des résultats par :

// Dans votre openvas.html, REMPLACER la section d'affichage des résultats par :

function viewResults(taskId, scanName) {
    const modal = new bootstrap.Modal(document.getElementById('resultsModal'));
    const resultsDiv = document.getElementById('scan-results');
    
    // Afficher le loader
    resultsDiv.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-2">Récupération des résultats...</p>
        </div>
    `;
    
    modal.show();
    
    // Récupérer les résultats réels
    fetch(`/openvas/results/${taskId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ✅ SEULEMENT 3 CARTES - PAS DE CRITICAL
            resultsDiv.innerHTML = `
                <h6>📊 Résultats pour: ${scanName}</h6>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="card text-center border-danger">
                            <div class="card-body">
                                <h5 class="card-title text-danger">${data.results.high || 0}</h5>
                                <p class="card-text">🔴 Élevées</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center border-warning">
                            <div class="card-body">
                                <h5 class="card-title text-warning">${data.results.medium || 0}</h5>
                                <p class="card-text">🟡 Moyennes</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center border-info">
                            <div class="card-body">
                                <h5 class="card-title text-info">${data.results.low || 0}</h5>
                                <p class="card-text">🔵 Faibles</p>
                            </div>
                        </div>
                    </div>
                </div>
            
                
                <div class="alert alert-info">
                    <strong>📋 Total détections:</strong> ${data.results.total || 0}<br>
                    <strong>⏱️ Durée du scan:</strong> ${data.results.duration || 'N/A'}<br>
                    <strong>🎯 Task ID:</strong> ${taskId}
                </div>
                
                ${data.results.vulnerabilities && data.results.vulnerabilities.length > 0 ? `
                <h6>🔍 Top vulnérabilités:</h6>
                <div class="list-group">
                    ${data.results.vulnerabilities.slice(0, 5).map(vuln => `
                        <div class="list-group-item">
                            <small class="text-muted">${vuln}</small>
                        </div>
                    `).join('')}
                </div>
                ` : '<p class="text-success">🎉 Aucune vulnérabilité critique détectée !</p>'}
                
                <div class="mt-3">
                    <a href="https://localhost:9392" target="_blank" class="btn btn-primary">
                        🌐 Voir rapport complet sur OpenVAS
                    </a>
                </div>
            `;
        } else {
            resultsDiv.innerHTML = `
                <div class="alert alert-warning">
                    <h6>⚠️ Résultats non disponibles</h6>
                    <p>${data.message || 'Les résultats ne sont pas encore prêts ou une erreur est survenue.'}</p>
                    <a href="https://localhost:9392" target="_blank" class="btn btn-outline-primary">
                        🌐 Vérifier sur l'interface OpenVAS
                    </a>
                </div>
            `;
        }
    })
    .catch(error => {
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <h6>❌ Erreur de récupération</h6>
                <p>Impossible de récupérer les résultats. Erreur: ${error.message}</p>
                <a href="https://localhost:9392" target="_blank" class="btn btn-outline-primary">
                    🌐 Consulter directement OpenVAS
                </a>
            </div>
        `;
    });
}


// Démarrer l'auto-refresh au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    if (document.querySelector('#active-scans .scan-item')) {
        startAutoRefresh();
        console.log('🔄 Auto-refresh activé (15s)');
    }
});

// Arrêter l'auto-refresh quand on quitte la page
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});
</script>

{% endblock %}
