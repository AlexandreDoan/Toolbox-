{% extends "base.html" %}
{% block title %}Exploitation - Metasploit{% endblock %}
{% block content %}

<div class="container mt-4">
    <h2>üéØ Metasploit Framework</h2>
    <p class="text-muted">Recherche d'exploits, configuration et exploitation</p>

    <!-- Alerte de s√©curit√© -->
    <div class="alert alert-danger border-danger">
        <h6>‚ö†Ô∏è AVERTISSEMENT L√âGAL</h6>
        <p class="mb-0">N'utilisez ces outils que sur vos propres syst√®mes ou avec autorisation explicite √©crite. 
        Les tests de p√©n√©tration non autoris√©s sont ill√©gaux.</p>
    </div>

    <!-- Navigation par onglets -->
    <ul class="nav nav-tabs nav-fill" id="metasploitTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-pane" 
                    type="button" role="tab" aria-controls="search-pane" aria-selected="true">
                üîç Recherche d'exploits
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="exploit-tab" data-bs-toggle="tab" data-bs-target="#exploit-pane" 
                    type="button" role="tab" aria-controls="exploit-pane" aria-selected="false">
                üéØ Configuration & Exploitation
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="test-tab" data-bs-toggle="tab" data-bs-target="#test-pane" 
                    type="button" role="tab" aria-controls="test-pane" aria-selected="false">
                üß™ Test Framework
            </button>
        </li>
    </ul>

    <!-- Contenu des onglets -->
    <div class="tab-content" id="metasploitTabContent">
        
        <!-- ===== ONGLET 1: RECHERCHE D'EXPLOITS ===== -->
        <div class="tab-pane fade show active" id="search-pane" role="tabpanel" aria-labelledby="search-tab">
            <div class="card mt-3">
                <div class="card-header bg-info text-white">
                    <h5>üîé Recherche dans la base Metasploit</h5>
                </div>
                <div class="card-body">
                    <form id="searchForm">
                        
                        <!-- Recherche principale -->
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="searchQuery" class="form-label">üéØ Recherche libre</label>
                                <input type="text" class="form-control form-control-lg" id="searchQuery" name="searchQuery" 
                                       placeholder="ssh, apache, windows, CVE-2021-44228..." autofocus>
                                <div class="form-text">
                                    Recherchez par service, logiciel, OS, CVE ou mot-cl√©
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="submit" class="btn btn-info btn-lg w-100" id="searchBtn">
                                    üîç Rechercher
                                </button>
                            </div>
                        </div>

                        <!-- Filtres avanc√©s -->
                        <div class="row">
                            <div class="col-md-4">
                                <label for="service" class="form-label">üîß Service</label>
                                <select class="form-control" id="service" name="service">
                                    <option value="">Tous les services</option>
                                    <option value="ssh">SSH</option>
                                    <option value="http">HTTP</option>
                                    <option value="ftp">FTP</option>
                                    <option value="smb">SMB</option>
                                    <option value="mysql">MySQL</option>
                                    <option value="postgresql">PostgreSQL</option>
                                    <option value="apache">Apache</option>
                                    <option value="nginx">Nginx</option>
                                    <option value="wordpress">WordPress</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="platform" class="form-label">üíª Plateforme</label>
                                <select class="form-control" id="platform" name="platform">
                                    <option value="">Toutes les plateformes</option>
                                    <option value="windows">Windows</option>
                                    <option value="linux">Linux</option>
                                    <option value="unix">Unix</option>
                                    <option value="osx">Mac OS X</option>
                                    <option value="java">Java</option>
                                    <option value="php">PHP</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="cve" class="form-label">üÜî CVE</label>
                                <input type="text" class="form-control" id="cve" name="cve" 
                                       placeholder="CVE-2021-44228">
                            </div>
                        </div>

                        <!-- Options -->
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="exploitsOnly" name="exploitsOnly" checked>
                                    <label class="form-check-label" for="exploitsOnly">
                                        ‚ö° Exploits seulement
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="auxiliaryOnly" name="auxiliaryOnly">
                                    <label class="form-check-label" for="auxiliaryOnly">
                                        üîß Modules auxiliaires seulement
                                    </label>
                                </div>
                            </div>
                        </div>

                    </form>
                </div>
            </div>

            <!-- Recherches populaires -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6>üî• Recherches populaires</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <h6>üîê Services r√©seau</h6>
                            <div class="d-grid gap-1">
                                <button class="btn btn-outline-primary btn-sm" onclick="quickSearch('ssh')">SSH</button>
                                <button class="btn btn-outline-primary btn-sm" onclick="quickSearch('smb')">SMB</button>
                                <button class="btn btn-outline-primary btn-sm" onclick="quickSearch('ftp')">FTP</button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <h6>üåê Applications web</h6>
                            <div class="d-grid gap-1">
                                <button class="btn btn-outline-success btn-sm" onclick="quickSearch('apache')">Apache</button>
                                <button class="btn btn-outline-success btn-sm" onclick="quickSearch('nginx')">Nginx</button>
                                <button class="btn btn-outline-success btn-sm" onclick="quickSearch('wordpress')">WordPress</button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <h6>üì± CVE populaires</h6>
                            <div class="d-grid gap-1">
                                <button class="btn btn-outline-danger btn-sm" onclick="quickSearch('CVE-2021-44228')">Log4j</button>
                                <button class="btn btn-outline-danger btn-sm" onclick="quickSearch('CVE-2017-0144')">EternalBlue</button>
                                <button class="btn btn-outline-danger btn-sm" onclick="quickSearch('CVE-2019-0708')">BlueKeep</button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <h6>üíª Syst√®mes</h6>
                            <div class="d-grid gap-1">
                                <button class="btn btn-outline-warning btn-sm" onclick="quickSearch('windows')">Windows</button>
                                <button class="btn btn-outline-warning btn-sm" onclick="quickSearch('linux')">Linux</button>
                                <button class="btn btn-outline-warning btn-sm" onclick="quickSearch('android')">Android</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Zone de statut de recherche -->
            <div class="card mt-3" id="searchStatusCard" style="display: none;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>üîç Recherche en cours</h5>
                    <span class="badge bg-info" id="searchTaskStatus">Recherche...</span>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Recherche en cours...</span>
                        </div>
                    </div>
                    <p class="text-center mt-2" id="searchStatusText">Interrogation de la base Metasploit...</p>
                </div>
            </div>

            <!-- R√©sultats de recherche -->
            <div class="card mt-3" id="searchResultsCard" style="display: none;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>üìã R√©sultats de recherche</h5>
                    <span class="badge bg-success" id="resultsCount">0 r√©sultats</span>
                </div>
                <div class="card-body">
                    <div id="searchResults">
                        <!-- Les r√©sultats seront inject√©s ici -->
                    </div>
                </div>
            </div>

        </div>

        <!-- ===== ONGLET 2: EXPLOITATION ===== -->
        <div class="tab-pane fade" id="exploit-pane" role="tabpanel" aria-labelledby="exploit-tab">
            <div class="card mt-3">
                <div class="card-header bg-dark text-white">
                    <h5>üéØ Configuration de l'exploitation</h5>
                </div>
                <div class="card-body">
                    <form id="exploitationForm">
                        
                        <!-- Cible et port -->
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="target" class="form-label">üéØ Cible</label>
                                <input type="text" class="form-control" id="target" name="target" 
                                       placeholder="192.168.1.100 ou example.com" required>
                                <div class="form-text">IP ou nom d'h√¥te de la cible</div>
                            </div>
                            <div class="col-md-4">
                                <label for="port" class="form-label">üîå Port</label>
                                <input type="number" class="form-control" id="port" name="port" 
                                       value="22" min="1" max="65535">
                            </div>
                        </div>

                        <!-- Service et module -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="serviceExploit" class="form-label">üîß Service</label>
                                <select class="form-control" id="serviceExploit" name="serviceExploit" onchange="updateModules()">
                                    <option value="">S√©lectionner un service...</option>
                                    <option value="ssh">SSH (22)</option>
                                    <option value="http">HTTP (80)</option>
                                    <option value="https">HTTPS (443)</option>
                                    <option value="ftp">FTP (21)</option>
                                    <option value="smb">SMB (445)</option>
                                    <option value="mysql">MySQL (3306)</option>
                                    <option value="postgresql">PostgreSQL (5432)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="exploit_module" class="form-label">‚ö° Module d'exploitation</label>
                                <select class="form-control" id="exploit_module" name="exploit_module">
                                    <option value="">Auto-s√©lection selon le service</option>
                                </select>
                                <div class="form-text">
                                    <button type="button" class="btn btn-link p-0" onclick="switchToSearchTab()">
                                        üîç Rechercher des exploits
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Mode d'exploitation -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">üé≠ Mode d'exploitation</label>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="mode" id="mode_safe" value="safe" checked>
                                            <label class="form-check-label" for="mode_safe">
                                                <span class="badge bg-success">üõ°Ô∏è S√©curis√©</span><br>
                                                <small>Modules auxiliaires seulement</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="mode" id="mode_test" value="test">
                                            <label class="form-check-label" for="mode_test">
                                                <span class="badge bg-warning text-dark">üß™ Test</span><br>
                                                <small>V√©rification de vuln√©rabilit√©s</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="mode" id="mode_exploit" value="exploit">
                                            <label class="form-check-label" for="mode_exploit">
                                                <span class="badge bg-danger">‚ö†Ô∏è Exploitation</span><br>
                                                <small>Exploitation r√©elle</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Options avanc√©es -->
                        <div class="accordion mb-3" id="advancedOptions">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#advancedCollapse">
                                        ‚öôÔ∏è Options avanc√©es
                                    </button>
                                </h2>
                                <div id="advancedCollapse" class="accordion-collapse collapse" data-bs-parent="#advancedOptions">
                                    <div class="accordion-body">
                                        
                                        <!-- Payload -->
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="payload" class="form-label">üí• Payload</label>
                                                <select class="form-control" id="payload" name="payload">
                                                    <option value="">Auto-s√©lection</option>
                                                    <option value="generic/shell_reverse_tcp">Shell Reverse TCP</option>
                                                    <option value="linux/x64/meterpreter/reverse_tcp">Linux Meterpreter</option>
                                                    <option value="windows/meterpreter/reverse_tcp">Windows Meterpreter</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="lhost" class="form-label">üè† LHOST</label>
                                                <input type="text" class="form-control" id="lhost" name="lhost" 
                                                       value="127.0.0.1">
                                            </div>
                                            <div class="col-md-3">
                                                <label for="lport" class="form-label">üîå LPORT</label>
                                                <input type="number" class="form-control" id="lport" name="lport" 
                                                       value="4444" min="1" max="65535">
                                            </div>
                                        </div>

                                        <!-- Variables personnalis√©es -->
                                        <div class="mb-3">
                                            <label for="custom_options" class="form-label">üìã Variables personnalis√©es</label>
                                            <textarea class="form-control" id="custom_options" name="custom_options" rows="3"
                                                      placeholder="USER=admin&#10;PASS=password123"></textarea>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Boutons d'action -->
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="submit" class="btn btn-danger btn-lg" id="startExploitBtn">
                                    üöÄ Lancer l'exploitation
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="testConnection()">
                                    üîç Test de connexion
                                </button>
                            </div>
                            <div>
                                <button type="button" class="btn btn-outline-secondary" onclick="loadExploitPresets()">
                                    üìã Presets
                                </button>
                            </div>
                        </div>

                    </form>
                </div>
            </div>

            <!-- Monitoring de l'exploitation -->
            <div class="card mt-3" id="exploitMonitoringCard" style="display: none;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>üéØ Exploitation en cours</h5>
                    <span class="badge bg-danger" id="exploitTaskStatus">En cours...</span>
                </div>
                <div class="card-body">
                    
                    <!-- Progression -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span id="exploitStatusText">Initialisation...</span>
                            <span id="exploitProgressText">0%</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-danger" 
                                 id="exploitProgressBar" role="progressbar" style="width: 0%">
                                0%
                            </div>
                        </div>
                    </div>

                    <!-- Informations en temps r√©el -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="card border-info">
                                <div class="card-body text-center p-2">
                                    <h6 id="sessionsCount">0</h6>
                                    <small>Sessions ouvertes</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-warning">
                                <div class="card-body text-center p-2">
                                    <h6 id="vulnsFound">0</h6>
                                    <small>Vuln√©rabilit√©s</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-success">
                                <div class="card-body text-center p-2">
                                    <h6 id="credsFound">0</h6>
                                    <small>Credentials</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="viewExploitDetails()" id="exploitDetailsBtn">
                            üëÅÔ∏è Voir d√©tails
                        </button>
                        <button class="btn btn-outline-danger" onclick="cancelExploit()" id="exploitCancelBtn">
                            üõë Arr√™ter
                        </button>
                    </div>
                </div>
            </div>

            <!-- Presets rapides -->
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <h6>üß™ Tests s√©curis√©s</h6>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-outline-primary w-100 mb-2" onclick="loadDVWATest()">
                                üéØ Test DVWA Local
                            </button>
                            <button class="btn btn-outline-info w-100 mb-2" onclick="loadSSHTest()">
                                üîê Test SSH Local
                            </button>
                            <button class="btn btn-outline-success w-100" onclick="loadHTTPTest()">
                                üåê Test HTTP Local
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h6>üìö Ressources</h6>
                        </div>
                        <div class="card-body">
                            <a href="https://www.metasploit.com/" target="_blank" class="btn btn-outline-info w-100 mb-2">
                                üìñ Documentation
                            </a>
                            <button class="btn btn-outline-info w-100 mb-2" onclick="showPayloadInfo()">
                                üí• Guide Payloads
                            </button>
                            <button class="btn btn-outline-info w-100" onclick="showBestPractices()">
                                üõ°Ô∏è Bonnes pratiques
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== ONGLET 3: TEST FRAMEWORK ===== -->
        <div class="tab-pane fade" id="test-pane" role="tabpanel" aria-labelledby="test-tab">
            <div class="card mt-3">
                <div class="card-header bg-success text-white">
                    <h5>üß™ Test du Framework Metasploit</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6>‚ÑπÔ∏è √Ä propos du test</h6>
                        <p class="mb-0">Ce test v√©rifie que Metasploit est correctement install√© et fonctionnel dans votre environnement.</p>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6>üîß Tests effectu√©s :</h6>
                            <ul>
                                <li>‚úÖ Disponibilit√© de msfconsole</li>
                                <li>‚úÖ Version du framework</li>
                                <li>‚úÖ Base de donn√©es d'exploits</li>
                                <li>‚úÖ Module auxiliaire simple</li>
                                <li>‚úÖ Recherche d'exploits</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>‚è±Ô∏è Dur√©e estim√©e :</h6>
                            <p>2-5 minutes selon votre syst√®me</p>
                            
                            <h6>üéØ Objectif :</h6>
                            <p>Valider l'int√©gration compl√®te avant utilisation en production</p>
                        </div>
                    </div>

                    <button class="btn btn-success btn-lg" onclick="startMetasploitTest()" id="testMsfBtn">
                        üß™ Lancer le test complet
                    </button>

                </div>
            </div>

            <!-- Zone de monitoring du test -->
            <div class="card mt-3" id="testMonitoringCard" style="display: none;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>üß™ Test en cours</h5>
                    <span class="badge bg-success" id="testTaskStatus">Test...</span>
                </div>
                <div class="card-body">
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span id="testStatusText">Initialisation...</span>
                            <span id="testProgressText">0%</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                 id="testProgressBar" role="progressbar" style="width: 0%">
                                0%
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="viewTestDetails()" id="testDetailsBtn">
                            üëÅÔ∏è Voir d√©tails
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
let currentExploitTaskId = null;
let currentSearchTaskId = null;
let currentTestTaskId = null;
let exploitMonitoringInterval = null;
let searchMonitoringInterval = null;
let testMonitoringInterval = null;

// Modules par service
const serviceModules = {
    'ssh': [
        {value: 'auxiliary/scanner/ssh/ssh_version', name: 'üîç SSH Version Scanner'},
        {value: 'auxiliary/scanner/ssh/ssh_login', name: 'üîê SSH Login Scanner'},
        {value: 'auxiliary/scanner/ssh/ssh_enumusers', name: 'üë• SSH User Enumeration'}
    ],
    'http': [
        {value: 'auxiliary/scanner/http/http_version', name: 'üîç HTTP Version Scanner'},
        {value: 'auxiliary/scanner/http/dir_scanner', name: 'üìÅ Directory Scanner'},
        {value: 'auxiliary/scanner/http/http_login', name: 'üîê HTTP Login Scanner'}
    ],
    'smb': [
        {value: 'auxiliary/scanner/smb/smb_version', name: 'üîç SMB Version Scanner'},
        {value: 'auxiliary/scanner/smb/smb_login', name: 'üîê SMB Login Scanner'},
        {value: 'auxiliary/scanner/smb/smb_enumshares', name: 'üìÅ SMB Share Enumeration'}
    ],
    'ftp': [
        {value: 'auxiliary/scanner/ftp/ftp_version', name: 'üîç FTP Version Scanner'},
        {value: 'auxiliary/scanner/ftp/ftp_login', name: 'üîê FTP Login Scanner'},
        {value: 'auxiliary/scanner/ftp/anonymous', name: 'üë§ FTP Anonymous Access'}
    ]
};

// ===== RECHERCHE D'EXPLOITS =====

document.getElementById('searchForm').addEventListener('submit', function(e) {
    e.preventDefault();
    performSearch();
});

// Synchroniser les checkboxes exploits/auxiliaires
document.getElementById('exploitsOnly').addEventListener('change', function() {
    if (this.checked) {
        document.getElementById('auxiliaryOnly').checked = false;
    }
});

document.getElementById('auxiliaryOnly').addEventListener('change', function() {
    if (this.checked) {
        document.getElementById('exploitsOnly').checked = false;
    }
});

function performSearch() {
    const formData = new FormData(document.getElementById('searchForm'));
    
    const searchParams = {
        query: formData.get('searchQuery'),
        service: formData.get('service'),
        platform: formData.get('platform'),
        cve: formData.get('cve'),
        exploits_only: formData.get('exploitsOnly') === 'on',
        auxiliary_only: formData.get('auxiliaryOnly') === 'on'
    };
    
    if (!searchParams.query && !searchParams.service && !searchParams.platform && !searchParams.cve) {
        alert('‚ö†Ô∏è Veuillez sp√©cifier au moins un crit√®re de recherche');
        return;
    }
    
    showSearchStatus();
    
    document.getElementById('searchBtn').disabled = true;
    document.getElementById('searchBtn').innerHTML = 'üîÑ Recherche...';
    
    // ATTENTION : Route API √† cr√©er
    fetch('/huntkit/api/metasploit/search/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(searchParams)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentSearchTaskId = data.task_id;
            startSearchMonitoring();
            showNotification('‚úÖ Recherche lanc√©e', 'success');
        } else {
            showNotification('‚ùå ' + data.error, 'danger');
            resetSearchForm();
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('‚ùå Erreur de connexion', 'danger');
        resetSearchForm();
    });
}

function showSearchStatus() {
    document.getElementById('searchStatusCard').style.display = 'block';
    document.getElementById('searchResultsCard').style.display = 'none';
    document.getElementById('searchStatusCard').scrollIntoView({behavior: 'smooth'});
}

function startSearchMonitoring() {
    if (!currentSearchTaskId) return;
    
    searchMonitoringInterval = setInterval(() => {
        fetch(`/tasks/api/${currentSearchTaskId}/status`)
            .then(response => response.json())
            .then(data => {
                if (data.success !== false) {
                    if (data.unified_state === 'SUCCESS') {
                        clearInterval(searchMonitoringInterval);
                        displaySearchResults(data.result);
                        resetSearchForm();
                    } else if (data.unified_state === 'FAILURE') {
                        clearInterval(searchMonitoringInterval);
                        showNotification('‚ùå Erreur lors de la recherche: ' + (data.error || 'Erreur inconnue'), 'danger');
                        resetSearchForm();
                    } else {
                        const statusText = data.unified_status || 'Recherche en cours...';
                        document.getElementById('searchStatusText').textContent = statusText;
                    }
                }
            })
            .catch(error => {
                console.error('Erreur monitoring:', error);
                clearInterval(searchMonitoringInterval);
                resetSearchForm();
            });
    }, 2000);
}

function displaySearchResults(result) {
    document.getElementById('searchStatusCard').style.display = 'none';
    
    if (!result || !result.results || !result.results.exploits_found) {
        document.getElementById('searchResultsCard').style.display = 'block';
        document.getElementById('searchResults').innerHTML = `
            <div class="alert alert-warning">
                <h6>üîç Aucun r√©sultat trouv√©</h6>
                <p class="mb-0">Essayez avec des crit√®res diff√©rents ou moins restrictifs.</p>
            </div>
        `;
        document.getElementById('resultsCount').textContent = '0 r√©sultats';
        return;
    }
    
    const exploits = result.results.exploits_found;
    const resultsContainer = document.getElementById('searchResults');
    
    document.getElementById('resultsCount').textContent = `${exploits.length} r√©sultat${exploits.length > 1 ? 's' : ''}`;
    
    let resultsHTML = '';
    
    exploits.forEach((exploit, index) => {
        const isExploit = exploit.type === 'exploit';
        const moduleTypeClass = isExploit ? 'danger' : 'info';
        const moduleTypeIcon = isExploit ? '‚ö°' : 'üîß';
        const moduleTypeName = isExploit ? 'EXPLOIT' : 'AUXILIARY';
        
        const modulePath = exploit.module || 'N/A';
        const description = exploit.description || 'Aucune description disponible';
        
        resultsHTML += `
            <div class="card mb-3 border-${moduleTypeClass} result-item" data-module="${modulePath}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">
                            <span class="badge bg-${moduleTypeClass}">${moduleTypeIcon} ${moduleTypeName}</span>
                            <code class="ms-2">${modulePath}</code>
                        </h6>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="useModule('${modulePath}')" title="Utiliser ce module">
                            üéØ Utiliser
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="copyModule('${modulePath}')" title="Copier le nom du module">
                            üìã Copier
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <p class="mb-2">${description}</p>
                    <div class="text-muted">
                        <small><strong>Type:</strong> ${moduleTypeName}</small>
                    </div>
                </div>
            </div>
        `;
    });
    
    resultsContainer.innerHTML = resultsHTML;
    document.getElementById('searchResultsCard').style.display = 'block';
    document.getElementById('searchResultsCard').scrollIntoView({behavior: 'smooth'});
}

function resetSearchForm() {
    document.getElementById('searchBtn').disabled = false;
    document.getElementById('searchBtn').innerHTML = 'üîç Rechercher';
    currentSearchTaskId = null;
}

function quickSearch(query) {
    document.getElementById('searchQuery').value = query;
    
    if (['ssh', 'smb', 'ftp', 'apache', 'nginx'].includes(query)) {
        document.getElementById('service').value = query;
    } else if (['windows', 'linux', 'android'].includes(query)) {
        document.getElementById('platform').value = query;
    } else if (query.startsWith('CVE-')) {
        document.getElementById('cve').value = query;
    }
    
    performSearch();
}

function useModule(modulePath) {
    // Passer √† l'onglet exploitation et pr√©-remplir le module
    document.getElementById('exploit_module').innerHTML = `<option value="${modulePath}" selected>${modulePath}</option>`;
    
    // Activer l'onglet exploitation
    const exploitTab = new bootstrap.Tab(document.getElementById('exploit-tab'));
    exploitTab.show();
    
    showNotification(`‚úÖ Module s√©lectionn√©: ${modulePath}`, 'success');
}

function copyModule(modulePath) {
    navigator.clipboard.writeText(modulePath).then(() => {
        showNotification(`‚úÖ Module copi√©: ${modulePath}`, 'success', 2000);
    }).catch(err => {
        console.error('Erreur copie:', err);
        showNotification('‚ùå Erreur lors de la copie', 'danger');
    });
}

// ===== EXPLOITATION =====

document.getElementById('exploitationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    startExploitation();
});

function updateModules() {
    const service = document.getElementById('serviceExploit').value;
    const moduleSelect = document.getElementById('exploit_module');
    
    // Mettre √† jour le port selon le service
    const servicePorts = {
        'ssh': 22, 'http': 80, 'https': 443, 'ftp': 21, 
        'smb': 445, 'mysql': 3306, 'postgresql': 5432
    };
    
    if (servicePorts[service]) {
        document.getElementById('port').value = servicePorts[service];
    }
    
    // Mettre √† jour les modules disponibles
    moduleSelect.innerHTML = '<option value="">Auto-s√©lection selon le service</option>';
    
    if (serviceModules[service]) {
        serviceModules[service].forEach(module => {
            const option = document.createElement('option');
            option.value = module.value;
            option.textContent = module.name;
            moduleSelect.appendChild(option);
        });
    }
}

function startExploitation() {
    const formData = new FormData(document.getElementById('exploitationForm'));
    const target = formData.get('target');
    const port = parseInt(formData.get('port'));
    const service = formData.get('serviceExploit');
    const mode = formData.get('mode');
    
    if (!target) {
        alert('‚ö†Ô∏è Veuillez sp√©cifier une cible');
        return;
    }
    
    let confirmMessage = `Lancer une exploitation ${mode} sur ${target}:${port} ?`;
    if (mode === 'exploit') {
        confirmMessage = `‚ö†Ô∏è ATTENTION !\n\nVous allez lancer une EXPLOITATION R√âELLE sur:\n${target}:${port}\n\nAssurez-vous d'avoir l'AUTORISATION √âCRITE !\n\nContinuer ?`;
    }
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    const data = {
        target: target,
        port: port,
        service: service,
        exploit_module: formData.get('exploit_module'),
        options: {
            mode: mode,
            payload: formData.get('payload'),
            lhost: formData.get('lhost'),
            lport: formData.get('lport')
        }
    };
    
    // Ajouter les options personnalis√©es
    const customOptions = formData.get('custom_options');
    if (customOptions) {
        customOptions.split('\n').forEach(line => {
            const [key, value] = line.split('=');
            if (key && value) {
                data.options[key.trim()] = value.trim();
            }
        });
    }
    
    document.getElementById('startExploitBtn').disabled = true;
    document.getElementById('startExploitBtn').innerHTML = 'üîÑ Lancement...';
    
    // ATTENTION : Route API √† cr√©er ou adapter
    fetch('/huntkit/api/metasploit/exploitation/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentExploitTaskId = data.task_id;
            showExploitMonitoring();
            startExploitTaskMonitoring();
            showNotification('‚úÖ ' + data.message, 'success');
        } else {
            showNotification('‚ùå ' + data.error, 'danger');
            resetExploitForm();
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('‚ùå Erreur de connexion', 'danger');
        resetExploitForm();
    });
}

function showExploitMonitoring() {
    document.getElementById('exploitMonitoringCard').style.display = 'block';
    document.getElementById('exploitMonitoringCard').scrollIntoView({behavior: 'smooth'});
}

function startExploitTaskMonitoring() {
    if (!currentExploitTaskId) return;
    
    updateExploitTaskStatus();
    exploitMonitoringInterval = setInterval(updateExploitTaskStatus, 3000);
}

function updateExploitTaskStatus() {
    if (!currentExploitTaskId) return;
    
    fetch(`/tasks/api/${currentExploitTaskId}/status`)
        .then(response => response.json())
        .then(data => {
            if (data.success !== false) {
                updateExploitProgressUI(data);
                
                if (data.result && data.result.parsed_result) {
                    const parsed = data.result.parsed_result;
                    document.getElementById('sessionsCount').textContent = parsed.sessions_opened || 0;
                    document.getElementById('vulnsFound').textContent = (parsed.vulnerabilities_found || []).length;
                    document.getElementById('credsFound').textContent = (parsed.credentials_found || []).length;
                }
                
                if (data.unified_state === 'SUCCESS' || data.unified_state === 'FAILURE') {
                    stopExploitTaskMonitoring();
                    
                    if (data.unified_state === 'SUCCESS') {
                        setTimeout(() => {
                            window.location.href = `/tasks/${currentExploitTaskId}/results`;
                        }, 3000);
                    }
                }
            }
        })
        .catch(error => {
            console.error('Erreur monitoring exploit:', error);
        });
}

function updateExploitProgressUI(data) {
    const progress = data.unified_progress || data.progress || 0;
    const status = data.unified_status || data.status || 'En cours...';
    const state = data.unified_state || data.state || 'PENDING';
    
    const progressBar = document.getElementById('exploitProgressBar');
    progressBar.style.width = `${progress}%`;
    progressBar.textContent = `${progress}%`;
    
    document.getElementById('exploitStatusText').textContent = status;
    document.getElementById('exploitProgressText').textContent = `${progress}%`;
    
    const taskStatus = document.getElementById('exploitTaskStatus');
    if (state === 'SUCCESS') {
        taskStatus.textContent = 'Termin√© ‚úÖ';
        taskStatus.className = 'badge bg-success';
        progressBar.className = 'progress-bar bg-success';
        progressBar.classList.remove('progress-bar-animated');
    } else if (state === 'FAILURE') {
        taskStatus.textContent = 'Erreur ‚ùå';
        taskStatus.className = 'badge bg-danger';
        progressBar.className = 'progress-bar bg-danger';
        progressBar.classList.remove('progress-bar-animated');
    }
}

function stopExploitTaskMonitoring() {
    if (exploitMonitoringInterval) {
        clearInterval(exploitMonitoringInterval);
        exploitMonitoringInterval = null;
    }
}

function resetExploitForm() {
    document.getElementById('startExploitBtn').disabled = false;
    document.getElementById('startExploitBtn').innerHTML = 'üöÄ Lancer l\'exploitation';
    document.getElementById('exploitMonitoringCard').style.display = 'none';
    currentExploitTaskId = null;
}

// ===== TEST FRAMEWORK =====

function startMetasploitTest() {
    document.getElementById('testMsfBtn').disabled = true;
    document.getElementById('testMsfBtn').innerHTML = 'üîÑ Test en cours...';
    
    document.getElementById('testMonitoringCard').style.display = 'block';
    
    // ATTENTION : Route API √† cr√©er
    fetch('/huntkit/api/metasploit/test/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentTestTaskId = data.task_id;
            startTestMonitoring();
            showNotification('‚úÖ Test Metasploit lanc√©', 'success');
        } else {
            showNotification('‚ùå ' + data.error, 'danger');
            resetTestForm();
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('‚ùå Erreur de connexion', 'danger');
        resetTestForm();
    });
}

function startTestMonitoring() {
    if (!currentTestTaskId) return;
    
    testMonitoringInterval = setInterval(() => {
        fetch(`/tasks/api/${currentTestTaskId}/status`)
            .then(response => response.json())
            .then(data => {
                if (data.success !== false) {
                    updateTestProgressUI(data);
                    
                    if (data.unified_state === 'SUCCESS' || data.unified_state === 'FAILURE') {
                        clearInterval(testMonitoringInterval);
                        
                        if (data.unified_state === 'SUCCESS') {
                            setTimeout(() => {
                                window.location.href = `/tasks/${currentTestTaskId}/results`;
                            }, 2000);
                        }
                        resetTestForm();
                    }
                }
            })
            .catch(error => {
                console.error('Erreur monitoring test:', error);
                clearInterval(testMonitoringInterval);
                resetTestForm();
            });
    }, 2000);
}

function updateTestProgressUI(data) {
    const progress = data.unified_progress || data.progress || 0;
    const status = data.unified_status || data.status || 'Test en cours...';
    const state = data.unified_state || data.state || 'PENDING';
    
    const progressBar = document.getElementById('testProgressBar');
    progressBar.style.width = `${progress}%`;
    progressBar.textContent = `${progress}%`;
    
    document.getElementById('testStatusText').textContent = status;
    document.getElementById('testProgressText').textContent = `${progress}%`;
    
    const taskStatus = document.getElementById('testTaskStatus');
    if (state === 'SUCCESS') {
        taskStatus.textContent = 'Termin√© ‚úÖ';
        taskStatus.className = 'badge bg-success';
        progressBar.className = 'progress-bar bg-success';
        progressBar.classList.remove('progress-bar-animated');
    } else if (state === 'FAILURE') {
        taskStatus.textContent = 'Erreur ‚ùå';
        taskStatus.className = 'badge bg-danger';
        progressBar.className = 'progress-bar bg-danger';
        progressBar.classList.remove('progress-bar-animated');
    }
}

function resetTestForm() {
    document.getElementById('testMsfBtn').disabled = false;
    document.getElementById('testMsfBtn').innerHTML = 'üß™ Lancer le test complet';
    currentTestTaskId = null;
}

// ===== FONCTIONS UTILITAIRES =====

function switchToSearchTab() {
    const searchTab = new bootstrap.Tab(document.getElementById('search-tab'));
    searchTab.show();
}

function testConnection() {
    const target = document.getElementById('target').value;
    const port = document.getElementById('port').value;
    
    if (!target) {
        alert('‚ö†Ô∏è Veuillez sp√©cifier une cible');
        return;
    }
    
    showNotification(`üîç Test de connexion vers ${target}:${port}...`, 'info');
}

// Presets
function loadDVWATest() {
    document.getElementById('target').value = 'localhost';
    document.getElementById('port').value = '8080';
    document.getElementById('serviceExploit').value = 'http';
    document.querySelector('input[name="mode"][value="safe"]').checked = true;
    updateModules();
}

function loadSSHTest() {
    document.getElementById('target').value = 'localhost';
    document.getElementById('port').value = '22';
    document.getElementById('serviceExploit').value = 'ssh';
    document.querySelector('input[name="mode"][value="safe"]').checked = true;
    updateModules();
}

function loadHTTPTest() {
    document.getElementById('target').value = 'localhost';
    document.getElementById('port').value = '5000';
    document.getElementById('serviceExploit').value = 'http';
    document.querySelector('input[name="mode"][value="safe"]').checked = true;
    updateModules();
}

function viewExploitDetails() {
    if (currentExploitTaskId) {
        window.open(`/tasks/${currentExploitTaskId}/status`, '_blank');
    }
}

function viewTestDetails() {
    if (currentTestTaskId) {
        window.open(`/tasks/${currentTestTaskId}/status`, '_blank');
    }
}

function cancelExploit() {
    if (!currentExploitTaskId) return;
    
    if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir arr√™ter cette exploitation ?')) {
        fetch(`/tasks/api/${currentExploitTaskId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('‚úÖ Exploitation arr√™t√©e', 'info');
                stopExploitTaskMonitoring();
                resetExploitForm();
            } else {
                showNotification('‚ùå Impossible d\'arr√™ter l\'exploitation', 'danger');
            }
        });
    }
}

function showNotification(message, type, duration = 4000) {
    if (typeof window.showNotification === 'function') {
        window.showNotification(message, type, duration);
    } else {
        alert(message);
    }
}

// Nettoyage √† la fermeture
window.addEventListener('beforeunload', function() {
    if (exploitMonitoringInterval) clearInterval(exploitMonitoringInterval);
    if (searchMonitoringInterval) clearInterval(searchMonitoringInterval);
    if (testMonitoringInterval) clearInterval(testMonitoringInterval);
});
</script>

<style>
.result-item:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transition: box-shadow 0.2s;
}

.nav-tabs .nav-link {
    font-weight: 500;
}

.nav-tabs .nav-link.active {
    background-color: #f8f9fa;
}
</style>

{% endblock %}
