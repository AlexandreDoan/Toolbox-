{% extends "base.html" %}
{% block title %}Statut des Outils - HuntKit{% endblock %}
{% block content %}

<div class="container mt-4">
    <h2>üîß Statut des Outils HuntKit</h2>
    <p class="text-muted">V√©rification de la disponibilit√© des outils de pentest</p>

    <!-- Bouton de v√©rification -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>üîç V√©rification</h5>
        </div>
        <div class="card-body">
            <button class="btn btn-primary btn-lg" onclick="checkToolsStatus()" id="checkButton">
                üîß V√©rifier les outils
            </button>
            <button class="btn btn-outline-info" onclick="refreshPage()">
                üîÑ Actualiser la page
            </button>
            <button class="btn btn-outline-secondary" onclick="showToolsInfo()">
                ‚ÑπÔ∏è Informations sur les outils
            </button>
        </div>
    </div>

    <!-- R√©sultats de v√©rification -->
    <div class="card" id="toolsStatusCard" style="display: none;">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>üìä R√©sultats de v√©rification</h5>
            <span class="badge bg-info" id="verificationStatus">En cours...</span>
        </div>
        <div class="card-body">
            <div id="toolsResults">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">V√©rification en cours...</span>
                    </div>
                    <p class="mt-2">V√©rification des outils en cours...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Informations sur les outils -->
    <div class="card" id="toolsInfoCard" style="display: none;">
        <div class="card-header">
            <h6>‚ÑπÔ∏è Informations sur les outils HuntKit</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">üåê Nmap</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>Fonction :</strong> D√©couverte r√©seau</p>
                            <ul class="small">
                                <li>Scan d'h√¥tes actifs</li>
                                <li>Scan de ports</li>
                                <li>D√©tection de services</li>
                                <li>Identification d'OS</li>
                            </ul>
                            <p><strong>Version attendue :</strong> 7.80+</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">üî® Hydra</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>Fonction :</strong> Force brute</p>
                            <ul class="small">
                                <li>Attaques par dictionnaire</li>
                                <li>Multiple protocoles</li>
                                <li>SSH, FTP, HTTP, etc.</li>
                                <li>Multi-threading</li>
                            </ul>
                            <p><strong>Version attendue :</strong> 9.0+</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">üï∑Ô∏è Nikto</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>Fonction :</strong> Scan web</p>
                            <ul class="small">
                                <li>Vuln√©rabilit√©s web</li>
                                <li>Fichiers dangereux</li>
                                <li>Configurations incorrectes</li>
                                <li>Versions obsol√®tes</li>
                            </ul>
                            <p><strong>Version attendue :</strong> 2.5+</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-4">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">üéØ Nuclei</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>Fonction :</strong> D√©tection automatis√©e</p>
                            <ul class="small">
                                <li>Templates de vuln√©rabilit√©s</li>
                                <li>CVE r√©cents</li>
                                <li>Misconfigurations</li>
                                <li>Mise √† jour continue</li>
                            </ul>
                            <p><strong>Version attendue :</strong> 3.0+</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0">üíâ SQLMap</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>Fonction :</strong> Injection SQL</p>
                            <ul class="small">
                                <li>D√©tection automatique</li>
                                <li>Exploitation</li>
                                <li>Extraction de donn√©es</li>
                                <li>Techniques avanc√©es</li>
                            </ul>
                            <p><strong>Version attendue :</strong> 1.7+</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-dark">
                        <div class="card-header bg-dark text-white">
                            <h6 class="mb-0">üé™ Metasploit</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>Fonction :</strong> Framework d'exploitation</p>
                            <ul class="small">
                                <li>Exploits</li>
                                <li>Payloads</li>
                                <li>Post-exploitation</li>
                                <li>Base de donn√©es de vuln√©rabilit√©s</li>
                            </ul>
                            <p><strong>Version attendue :</strong> 6.0+</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wordlists disponibles -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card border-secondary">
                <div class="card-header">
                    <h6>üìö Wordlists disponibles</h6>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            rockyou.txt
                            <span class="badge bg-primary rounded-pill">~14M mots</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            top1000-passwords.txt
                            <span class="badge bg-success rounded-pill">1K mots</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            common.txt
                            <span class="badge bg-info rounded-pill">R√©pertoires</span>
                        </li>
                    </ul>
                    <div class="mt-3">
                        <button class="btn btn-outline-secondary btn-sm" onclick="checkWordlists()">
                            üìö V√©rifier wordlists
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-secondary">
                <div class="card-header">
                    <h6>üê≥ Informations conteneur</h6>
                </div>
                <div class="card-body">
                    <p><strong>Image :</strong> HuntKit int√©gr√©</p>
                    <p><strong>Outils install√©s :</strong> 6 outils principaux</p>
                    <p><strong>R√©pertoire outils :</strong> /opt</p>
                    <p><strong>R√©pertoire wordlists :</strong> /usr/share/wordlists</p>
                    <div class="mt-3">
                        <button class="btn btn-outline-info btn-sm" onclick="showContainerInfo()">
                            üê≥ Infos d√©taill√©es
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentCheckTaskId = null;

function checkToolsStatus() {
    document.getElementById('checkButton').disabled = true;
    document.getElementById('checkButton').innerHTML = 'üîÑ V√©rification...';
    
    // Afficher la carte de r√©sultats
    document.getElementById('toolsStatusCard').style.display = 'block';
    document.getElementById('verificationStatus').textContent = 'En cours...';
    document.getElementById('verificationStatus').className = 'badge bg-info';
    
    // Lancer la v√©rification
    fetch('/huntkit/api/tools/status', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentCheckTaskId = data.task_id;
            monitorToolsCheck();
        } else {
            showError('Erreur lors du lancement de la v√©rification: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showError('Erreur de connexion');
    });
}

function monitorToolsCheck() {
    if (!currentCheckTaskId) return;
    
    const checkInterval = setInterval(() => {
        fetch(`/tasks/api/${currentCheckTaskId}/status`)
            .then(response => response.json())
            .then(data => {
                if (data.success !== false) {
                    if (data.unified_state === 'SUCCESS') {
                        clearInterval(checkInterval);
                        displayToolsResults(data.result);
                        resetCheckButton();
                    } else if (data.unified_state === 'FAILURE') {
                        clearInterval(checkInterval);
                        showError('Erreur lors de la v√©rification: ' + (data.error || 'Erreur inconnue'));
                        resetCheckButton();
                    }
                }
            })
            .catch(error => {
                console.error('Erreur monitoring:', error);
                clearInterval(checkInterval);
                showError('Erreur de monitoring');
                resetCheckButton();
            });
    }, 2000);
}

function displayToolsResults(result) {
    document.getElementById('verificationStatus').textContent = 'Termin√© ‚úÖ';
    document.getElementById('verificationStatus').className = 'badge bg-success';
    
    const toolsStatus = result.tools_status;
    const toolsAvailable = toolsStatus.tools_available;
    
    let html = '<div class="row">';
    
    const tools = [
        { name: 'nmap', title: 'Nmap', icon: 'üåê', color: 'primary' },
        { name: 'hydra', title: 'Hydra', icon: 'üî®', color: 'warning' },
        { name: 'nikto', title: 'Nikto', icon: 'üï∑Ô∏è', color: 'success' },
        { name: 'nuclei', title: 'Nuclei', icon: 'üéØ', color: 'info' },
        { name: 'sqlmap', title: 'SQLMap', icon: 'üíâ', color: 'danger' },
        { name: 'msfconsole', title: 'Metasploit', icon: 'üé™', color: 'dark' }
    ];
    
    tools.forEach(tool => {
        const isAvailable = toolsAvailable[tool.name] || false;
        const statusClass = isAvailable ? 'success' : 'danger';
        const statusIcon = isAvailable ? '‚úÖ' : '‚ùå';
        const statusText = isAvailable ? 'Disponible' : 'Non disponible';
        
        html += `
            <div class="col-md-4 mb-3">
                <div class="card border-${statusClass}">
                    <div class="card-body">
                        <h6>${tool.icon} ${tool.title}</h6>
                        <span class="badge bg-${statusClass}">${statusIcon} ${statusText}</span>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    // R√©sum√©
    const availableCount = Object.values(toolsAvailable).filter(Boolean).length;
    const totalCount = Object.keys(toolsAvailable).length;
    
    html += `
        <div class="alert alert-${availableCount === totalCount ? 'success' : 'warning'} mt-3">
            <h6>üìä R√©sum√©</h6>
            <p class="mb-0"><strong>${availableCount}/${totalCount}</strong> outils disponibles</p>
            ${availableCount === totalCount ? 
                '<p class="mb-0">‚úÖ Tous les outils sont pr√™ts pour les tests de p√©n√©tration !</p>' :
                '<p class="mb-0">‚ö†Ô∏è Certains outils ne sont pas disponibles. V√©rifiez l\'installation.'
            }
        </div>
    `;
    
    document.getElementById('toolsResults').innerHTML = html;
}

function showError(message) {
    document.getElementById('verificationStatus').textContent = 'Erreur ‚ùå';
    document.getElementById('verificationStatus').className = 'badge bg-danger';
    
    document.getElementById('toolsResults').innerHTML = `
        <div class="alert alert-danger">
            <h6>‚ùå Erreur</h6>
            <p class="mb-0">${message}</p>
        </div>
    `;
}

function resetCheckButton() {
    document.getElementById('checkButton').disabled = false;
    document.getElementById('checkButton').innerHTML = 'üîß V√©rifier les outils';
}

function refreshPage() {
    window.location.reload();
}

function showToolsInfo() {
    const card = document.getElementById('toolsInfoCard');
    card.style.display = card.style.display === 'none' ? 'block' : 'none';
}

function checkWordlists() {
    fetch('/huntkit/api/wordlists')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let message = 'Wordlists disponibles:\n\n';
                data.wordlists.forEach(wl => {
                    message += `${wl.available ? '‚úÖ' : '‚ùå'} ${wl.name}`;
                    if (wl.size_human) message += ` (${wl.size_human})`;
                    message += '\n';
                });
                alert(message);
            } else {
                alert('‚ùå Erreur lors de la v√©rification des wordlists');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('‚ùå Erreur de connexion');
        });
}

function showContainerInfo() {
    fetch('/huntkit/api/info')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const info = data.info;
                let message = `üê≥ Informations conteneur HuntKit\n\n`;
                message += `üì¶ Version: ${info.version}\n`;
                message += `üîß Outils: ${info.tools_included.length} int√©gr√©s\n`;
                message += `üìö Wordlists: ${info.wordlists_available.length} disponibles\n`;
                message += `üéØ Cibles support√©es: ${info.supported_targets.length} formats\n`;
                alert(message);
            } else {
                alert('‚ùå Erreur lors de la r√©cup√©ration des informations');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('‚ùå Erreur de connexion');
        });
}
</script>

{% endblock %})
