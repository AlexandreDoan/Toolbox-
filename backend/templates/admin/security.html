{% extends "base.html" %}
{% block title %}Gestion de la S√©curit√©{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h2>üîê Gestion de la S√©curit√©</h2>
            <p class="text-muted">T√¢ches 21 & 23 - Chiffrement et gestion des cl√©s</p>
            
            <!-- Statut des services de s√©curit√© -->
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5>üóÇÔ∏è MinIO</h5>
                        </div>
                        <div class="card-body">
                            {% if security_status.minio.available %}
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle"></i> Op√©rationnel
                                </div>
                                <small class="text-muted">
                                    Endpoint: {{ security_status.minio.endpoint }}<br>
                                    Buckets: {{ security_status.minio.buckets|length }}
                                </small>
                            {% else %}
                                <div class="alert alert-danger">
                                    <i class="fas fa-times-circle"></i> Non disponible
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5>üîë Gestion des Cl√©s</h5>
                        </div>
                        <div class="card-body">
                            {% if security_status.key_management.operational %}
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle"></i> Op√©rationnel
                                </div>
                                <small class="text-muted">
                                    Cl√©s: {{ security_status.key_management.key_info.total_keys }}<br>
                                    Stockage: {{ security_status.key_management.key_info.storage }}
                                </small>
                            {% else %}
                                <div class="alert alert-danger">
                                    <i class="fas fa-times-circle"></i> Non disponible
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5>üõ°Ô∏è Chiffrement</h5>
                        </div>
                        <div class="card-body">
                            {% if security_status.encryption.available %}
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle"></i> Op√©rationnel
                                </div>
                                <small class="text-muted">
                                    Algorithme: {{ security_status.encryption.algorithm }}<br>
                                    Test: {% if security_status.encryption.test_passed %}‚úÖ{% else %}‚ùå{% endif %}
                                </small>
                            {% else %}
                                <div class="alert alert-danger">
                                    <i class="fas fa-times-circle"></i> Non disponible
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Actions de s√©curit√© -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5>‚ö° Actions de S√©curit√©</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-info w-100 mb-2" onclick="testEncryption()">
                                <i class="fas fa-vial"></i> Tester le Chiffrement
                            </button>
                            <small class="text-muted">V√©rifie le cycle chiffrement/d√©chiffrement</small>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-warning w-100 mb-2" onclick="rotateEncryptionKey()">
                                <i class="fas fa-sync"></i> Rotation de Cl√©
                            </button>
                            <small class="text-muted">G√©n√®re une nouvelle cl√© de chiffrement</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Informations d√©taill√©es -->
            {% if security_status.encryption.available %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5>üìä D√©tails du Chiffrement</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Configuration:</strong>
                            <ul>
                                <li>Algorithme: {{ security_status.encryption.algorithm }}</li>
                                <li>Stockage cl√©s: {{ security_status.encryption.storage }}</li>
                                <li>Cl√© active: {{ security_status.encryption.key_info.current_key_id }}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <strong>Donn√©es chiffr√©es:</strong>
                            <ul>
                                <li>Sorties brutes des scans (raw_output)</li>
                                <li>Messages d'erreur sensibles</li>
                                <li>Credentials stock√©s</li>
                                <li>M√©tadonn√©es sensibles</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Conformit√© -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5>‚úÖ Conformit√© ESI M1 Cyber</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>T√¢che 21 - Chiffrement</h6>
                            <ul class="list-unstyled">
                                <li>‚úÖ Chiffrement Fernet (AES-128)</li>
                                <li>‚úÖ Donn√©es sensibles prot√©g√©es</li>
                                <li>‚úÖ Int√©gration transparente</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6>T√¢che 23 - Gestion des cl√©s</h6>
                            <ul class="list-unstyled">
                                <li>‚úÖ Stockage s√©curis√© MinIO</li>
                                <li>‚úÖ Rotation des cl√©s</li>
                                <li>‚úÖ Audit des acc√®s</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6>Architecture</h6>
                            <ul class="list-unstyled">
                                <li>‚úÖ Compatible S3</li>
                                <li>‚úÖ Scalable</li>
                                <li>‚úÖ Production-ready</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function testEncryption() {
    const button = event.target;
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Test en cours...';
    button.disabled = true;
    
    fetch('/admin/security/test-encryption', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        button.innerHTML = originalHTML;
        button.disabled = false;
        
        if (data.success) {
            showNotification('‚úÖ ' + data.message, 'success');
        } else {
            showNotification('‚ùå ' + data.message, 'danger');
        }
    })
    .catch(error => {
        button.innerHTML = originalHTML;
        button.disabled = false;
        showNotification('‚ùå Erreur: ' + error, 'danger');
    });
}

function rotateEncryptionKey() {
    if (!confirm('‚ö†Ô∏è Rotation de la cl√© de chiffrement ?\n\nCette action va :\n‚Ä¢ Archiver la cl√© actuelle\n‚Ä¢ G√©n√©rer une nouvelle cl√©\n‚Ä¢ Les nouvelles donn√©es seront chiffr√©es avec la nouvelle cl√©\n\nContinuer ?')) {
        return;
    }
    
    const button = event.target;
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Rotation...';
    button.disabled = true;
    
    fetch('/admin/security/rotate-key', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        button.innerHTML = originalHTML;
        button.disabled = false;
        
        if (data.success) {
            showNotification('‚úÖ ' + data.message, 'success');
            // Recommander un red√©marrage
            setTimeout(() => {
                if (confirm('Rotation termin√©e. Red√©marrer l\'application pour optimiser les performances ?')) {
                    window.location.href = '/';
                }
            }, 3000);
        } else {
            showNotification('‚ùå ' + data.message, 'danger');
        }
    })
    .catch(error => {
        button.innerHTML = originalHTML;
        button.disabled = false;
        showNotification('‚ùå Erreur: ' + error, 'danger');
    });
}

function showNotification(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>

{% endblock %}
