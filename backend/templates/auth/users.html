{% extends "base.html" %}
{% block title %}Liste des utilisateurs{% endblock %}
{% block content %}

<h2>Liste des utilisateurs</h2>

<!-- Messages flash -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

<table class="table table-striped mt-3">
  <thead>
    <tr>
      <th>Nom d'utilisateur</th>
      <th>RÃ´le</th>
      <th>Changer le mot de passe</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for user, role in users %}
      <tr>
        <td>{{ user }}</td>
        
        <!-- RÃ´le -->
        <td>
          {% if user != session.get('user') and user != 'admin' %}
            <form method="post" action="{{ url_for('update_role', username=user) }}" class="d-flex align-items-center">
              <select class="form-select form-select-sm me-2" name="role">
                <option value="admin" {% if role == 'admin' %}selected{% endif %}>admin</option>
                <option value="pentester" {% if role == 'pentester' %}selected{% endif %}>pentester</option>
                <option value="viewer" {% if role == 'viewer' %}selected{% endif %}>viewer</option>
              </select>
              <button class="btn btn-sm btn-primary">Mettre Ã  jour</button>
            </form>
          {% else %}
            {{ role }} {% if user == session.get('user') %}<span class="text-muted">(vous)</span>{% endif %}
          {% endif %}
        </td>

        <!-- Changement de mot de passe -->
        <td>
          {% if user != 'admin' %}
            <form method="post" action="{{ url_for('update_password', username=user) }}" class="d-flex align-items-center">
              <input type="password" class="form-control form-control-sm me-2" name="new_password" placeholder="Nouveau mot de passe" required minlength="6">
              <button class="btn btn-sm btn-warning">Modifier</button>
            </form>
          {% else %}
            <span class="text-muted">Compte protÃ©gÃ©</span>
          {% endif %}
        </td>

        <!-- Suppression -->
        <td>
          {% if user != session.get('user') and user != 'admin' %}
            <form method="post" action="{{ url_for('delete_user', username=user) }}" onsubmit="return confirm('Supprimer {{ user }} ?');">
              <button class="btn btn-sm btn-danger">ğŸ—‘ Supprimer</button>
            </form>
          {% else %}
            <span class="text-muted">Indisponible</span>
          {% endif %}
        </td>

      </tr>
    {% endfor %}
  </tbody>
</table>

{% endblock %}
