{% extends "base.html" %}
{% block title %}Monitoring de t√¢che{% endblock %}
{% block content %}

<div class="container mt-4">
    <h2>‚ö° Monitoring de t√¢che Celery</h2>
    <p class="text-muted">ID de t√¢che: <code>{{ task_id }}</code></p>
    
    <!-- Statut principal -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 id="task-title">üìä Statut de la t√¢che</h5>
            <div>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshStatus()">
                    üîÑ Actualiser
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="cancelTask()" id="cancel-btn">
                    üõë Annuler
                </button>
            </div>
        </div>
        <div class="card-body">
            
            <!-- Barre de progression -->
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-2">
                    <span id="status-text">Chargement du statut...</span>
                    <span id="progress-text">0%</span>
                </div>
                <div class="progress" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         id="progress-bar" 
                         role="progressbar" 
                         style="width: 0%">
                        0%
                    </div>
                </div>
            </div>
            
            <!-- Informations d√©taill√©es -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card border-info">
                        <div class="card-body">
                            <h6 class="card-title">‚ÑπÔ∏è Informations</h6>
                            <div id="task-info">
                                <p><strong>√âtat:</strong> <span id="task-state" class="badge bg-secondary">PENDING</span></p>
                                <p><strong>Cible:</strong> <span id="task-target">-</span></p>
                                <p><strong>Phase:</strong> <span id="task-phase">-</span></p>
                                <p><strong>Dur√©e:</strong> <span id="task-duration">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-success">
                        <div class="card-body">
                            <h6 class="card-title">‚è∞ Timestamps</h6>
                            <div id="task-timestamps">
                                <p><strong>D√©marrage:</strong> <span id="task-started">-</span></p>
                                <p><strong>Derni√®re MAJ:</strong> <span id="task-updated">-</span></p>
                                <p><strong>Termin√©:</strong> <span id="task-completed">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ‚úÖ R√âSULTATS D√âCOUVERTE R√âSEAU (affich√© seulement si termin√©) -->
            <div id="discovery-results" style="display: none;" class="mt-4">
                <div class="card border-success">
                    <div class="card-header">
                        <h6>üåê R√©sultats de la d√©couverte r√©seau</h6>
                    </div>
                    <div class="card-body" id="discovery-content">
                        <!-- Contenu des r√©sultats de d√©couverte sera inject√© ici -->
                    </div>
                </div>
            </div>
            
            <!-- R√©sultats autres t√¢ches (JSON) -->
            <div id="task-results" style="display: none;" class="mt-4">
                <div class="card border-success">
                    <div class="card-header">
                        <h6>‚úÖ R√©sultats</h6>
                    </div>
                    <div class="card-body">
                        <div id="results-content">
                            <!-- Contenu des r√©sultats sera inject√© ici -->
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-outline-primary" onclick="downloadResults()">
                                üíæ T√©l√©charger les r√©sultats
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Erreurs -->
            <div id="task-errors" style="display: none;" class="mt-4">
                <div class="card border-danger">
                    <div class="card-header">
                        <h6>‚ùå Erreur</h6>
                    </div>
                    <div class="card-body">
                        <div id="error-content" class="text-danger">
                            <!-- Contenu des erreurs sera inject√© ici -->
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- Log en temps r√©el -->
    <div class="card">
        <div class="card-header">
            <h6>üìã Log des activit√©s</h6>
        </div>
        <div class="card-body">
            <div id="activity-log" style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa; padding: 15px; border-radius: 5px;">
                <div class="text-muted">En attente du d√©but de la t√¢che...</div>
            </div>
        </div>
    </div>
    
    <!-- Actions rapides -->
    <div class="mt-4">
        <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">üè† Retour Dashboard</a>
        <a href="{{ url_for('tasks.tasks_dashboard') }}" class="btn btn-outline-info">üìä Toutes les t√¢ches</a>
    </div>
</div>

<script>
const taskId = '{{ task_id }}';
let refreshInterval;
let startTime = new Date();
let lastState = 'PENDING';

// D√©marrer le monitoring automatique
document.addEventListener('DOMContentLoaded', function() {
    refreshStatus();
    startAutoRefresh();
});

function startAutoRefresh() {
    refreshInterval = setInterval(refreshStatus, 2000); // Toutes les 2 secondes
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
}

function refreshStatus() {
    fetch(`/api/task/${taskId}/status`)
        .then(response => response.json())
        .then(data => {
            updateUI(data);
            
            // Arr√™ter l'auto-refresh si termin√©
            if (data.state === 'SUCCESS' || data.state === 'FAILURE') {
                stopAutoRefresh();
            }
        })
        .catch(error => {
            console.error('Erreur refresh:', error);
            addLogEntry('‚ùå Erreur de communication avec le serveur', 'error');
        });
}

function updateUI(data) {
    const state = data.state;
    const progress = data.progress || 0;
    const status = data.status || '√âtat inconnu';
    
    // Mettre √† jour le titre
    document.getElementById('task-title').textContent = `üìä T√¢che ${state}`;
    
    // Mettre √† jour la barre de progression
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    
    progressBar.style.width = `${progress}%`;
    progressBar.textContent = `${progress}%`;
    progressText.textContent = `${progress}%`;
    
    // Couleur de la barre selon l'√©tat
    progressBar.className = 'progress-bar progress-bar-striped';
    if (state === 'SUCCESS') {
        progressBar.classList.add('bg-success');
        progressBar.classList.remove('progress-bar-animated');
    } else if (state === 'FAILURE') {
        progressBar.classList.add('bg-danger');
        progressBar.classList.remove('progress-bar-animated');
    } else if (state === 'PROGRESS') {
        progressBar.classList.add('bg-warning', 'progress-bar-animated');
    } else {
        progressBar.classList.add('bg-info', 'progress-bar-animated');
    }
    
    // Mettre √† jour le statut
    document.getElementById('status-text').textContent = status;
    
    // Mettre √† jour le badge d'√©tat
    const stateBadge = document.getElementById('task-state');
    stateBadge.textContent = state;
    stateBadge.className = 'badge';
    
    if (state === 'SUCCESS') {
        stateBadge.classList.add('bg-success');
    } else if (state === 'FAILURE') {
        stateBadge.classList.add('bg-danger');
    } else if (state === 'PROGRESS') {
        stateBadge.classList.add('bg-warning');
    } else {
        stateBadge.classList.add('bg-secondary');
    }
    
    // Mettre √† jour les informations d√©taill√©es
    if (data.meta) {
        if (data.meta.target) {
            document.getElementById('task-target').textContent = data.meta.target;
        }
        if (data.meta.phase) {
            document.getElementById('task-phase').textContent = data.meta.phase;
        }
    }
    
    // Calculer la dur√©e
    const duration = Math.floor((new Date() - startTime) / 1000);
    document.getElementById('task-duration').textContent = `${duration}s`;
    
    // Mettre √† jour les timestamps
    document.getElementById('task-updated').textContent = new Date().toLocaleTimeString();
    
    // Ajouter au log si changement d'√©tat
    if (state !== lastState) {
        addLogEntry(`üìä √âtat: ${lastState} ‚Üí ${state}`, 'info');
        lastState = state;
    }
    
    // Ajouter au log les changements de statut
    if (status && status !== '√âtat inconnu') {
        addLogEntry(`‚ÑπÔ∏è ${status}`, 'info');
    }
    
    // ‚úÖ AFFICHER LES R√âSULTATS INTELLIGEMMENT
    if (state === 'SUCCESS' && data.result) {
        // V√©rifier si c'est une t√¢che de d√©couverte r√©seau
        if (isDiscoveryTask(data.result)) {
            showDiscoveryResults(data.result);
        } else {
            showResults(data.result);
        }
    }
    
    // Afficher les erreurs si √©chec
    if (state === 'FAILURE' && data.error) {
        showError(data.error);
    }
}

// ‚úÖ NOUVELLE FONCTION : D√©tecter si c'est une t√¢che de d√©couverte
function isDiscoveryTask(result) {
    return result && 
           result.result_data && 
           (result.result_data.summary || result.result_data.hosts || result.result_data.module === 'D√©couverte R√©seau');
}

// ‚úÖ NOUVELLE FONCTION : Afficher les r√©sultats de d√©couverte avec le bel affichage
function showDiscoveryResults(result) {
    const discoveryDiv = document.getElementById('discovery-results');
    const contentDiv = document.getElementById('discovery-content');
    
    const resultData = result.result_data;
    
    if (resultData && resultData.success) {
        let html = `
            <div class="alert alert-success">
                <h6>‚úÖ D√©couverte termin√©e avec succ√®s !</h6>
                <p><strong>üéØ R√©seau :</strong> ${resultData.target}</p>
            </div>
        `;
        
        // R√©sum√© avec cartes
        if (resultData.summary) {
            html += `
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center border-primary">
                            <div class="card-body">
                                <h5 class="card-title text-primary">${resultData.summary.total_hosts_found || 0}</h5>
                                <p class="card-text">üåê H√¥tes trouv√©s</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-success">
                            <div class="card-body">
                                <h5 class="card-title text-success">${resultData.summary.hosts_with_open_ports || 0}</h5>
                                <p class="card-text">üîì Avec ports ouverts</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-info">
                            <div class="card-body">
                                <h5 class="card-title text-info">${resultData.summary.total_open_ports || 0}</h5>
                                <p class="card-text">üî¢ Ports ouverts total</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-warning">
                            <div class="card-body">
                                <h5 class="card-title text-warning">${(resultData.summary.potential_servers || []).length}</h5>
                                <p class="card-text">üñ•Ô∏è Serveurs d√©tect√©s</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Tableau des h√¥tes d√©taill√©s
        if (resultData.hosts && resultData.hosts.length > 0) {
            html += `
                <h6>üîç D√©tails des h√¥tes :</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>IP</th>
                                <th>Statut</th>
                                <th style="width: 200px;">Ports ouverts</th>
                                <th style="width: 250px;">Services</th>
                                <th style="width: 200px;">OS</th>
                                <th style="width: 300px;">Infos</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            resultData.hosts.forEach(host => {
                html += `
                    <tr>
                        <td><strong>${host.ip}</strong></td>
                        <td>
                            ${host.scan_success ? 
                                '<span class="badge bg-success">Actif</span>' : 
                                '<span class="badge bg-danger">Erreur</span>'
                            }
                        </td>
                        <td>
                            ${host.ports && host.ports.length > 0 ? 
                                `<div style="max-height: 120px; overflow-y: auto;">
                                    ${host.ports.map(port => `<span class="badge bg-light text-dark d-block mb-1">${port.port}</span>`).join('')}
                                </div>` : 
                                '<span class="text-muted">Aucun</span>'
                            }
                        </td>
                        <td>
                            ${host.services && host.services.length > 0 ? 
                                `<div style="max-height: 120px; overflow-y: auto;">
                                    ${host.services.map(service => `<small class="text-info d-block mb-1">${service.version || service.service}</small>`).join('')}
                                </div>` : 
                                '<span class="text-muted">N/A</span>'
                            }
                        </td>
                        <td>
                            ${host.os ? 
                                `<div style="max-height: 120px; overflow-y: auto;">
                                    <small class="text-warning">${host.os}</small>
                                </div>` : 
                                '<span class="text-muted">Non d√©tect√©</span>'
                            }
                        </td>
                        <td>
                            ${host.additional_info && host.additional_info.length > 0 ? 
                                `<div style="max-height: 120px; overflow-y: auto;">
                                    ${host.additional_info.map(info => `<small class="text-primary d-block mb-1">‚Ä¢ ${info}</small>`).join('')}
                                </div>` : 
                                '<span class="text-muted">Aucune</span>'
                            }
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // Serveurs potentiels
        if (resultData.summary && resultData.summary.potential_servers && resultData.summary.potential_servers.length > 0) {
            html += `
                <h6>üñ•Ô∏è Serveurs d√©tect√©s :</h6>
                <div class="row">
            `;
            
            resultData.summary.potential_servers.forEach(server => {
                html += `
                    <div class="col-md-4 mb-2">
                        <div class="card border-warning">
                            <div class="card-body">
                                <h6 class="card-title">${server.ip}</h6>
                                <p class="card-text">
                                    <span class="badge bg-warning text-dark">${server.type}</span><br>
                                    <small>Ports: ${server.ports.join(', ')}</small>
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
            `;
        }
        
        contentDiv.innerHTML = html;
        discoveryDiv.style.display = 'block';
        
    } else {
        // Affichage d'erreur
        contentDiv.innerHTML = `
            <div class="alert alert-danger">
                <h6>‚ùå Erreur lors de la d√©couverte</h6>
                <p>${resultData.error || 'Erreur inconnue'}</p>
            </div>
        `;
        discoveryDiv.style.display = 'block';
    }
}

function addLogEntry(message, type = 'info') {
    const logDiv = document.getElementById('activity-log');
    const timestamp = new Date().toLocaleTimeString();
    
    const entry = document.createElement('div');
    entry.className = `mb-1 text-${type === 'error' ? 'danger' : 'dark'}`;
    entry.innerHTML = `<small class="text-muted">${timestamp}</small> ${message}`;
    
    logDiv.appendChild(entry);
    logDiv.scrollTop = logDiv.scrollHeight; // Auto-scroll
}

function showResults(result) {
    const resultsDiv = document.getElementById('task-results');
    const contentDiv = document.getElementById('results-content');
    
    // Formatter les r√©sultats selon le type
    let resultHtml = '<pre class="bg-light p-3 rounded">' + JSON.stringify(result, null, 2) + '</pre>';
    
    contentDiv.innerHTML = resultHtml;
    resultsDiv.style.display = 'block';
}

function showError(error) {
    const errorDiv = document.getElementById('task-errors');
    const contentDiv = document.getElementById('error-content');
    
    contentDiv.innerHTML = `<pre>${error}</pre>`;
    errorDiv.style.display = 'block';
}

function cancelTask() {
    if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir annuler cette t√¢che ?')) {
        fetch(`/api/task/${taskId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addLogEntry('üõë T√¢che annul√©e par l\'utilisateur', 'info');
                document.getElementById('cancel-btn').disabled = true;
                stopAutoRefresh();
            } else {
                addLogEntry('‚ùå √âchec de l\'annulation: ' + data.error, 'error');
            }
        })
        .catch(error => {
            addLogEntry('‚ùå Erreur annulation: ' + error, 'error');
        });
    }
}

function downloadResults() {
    // Cr√©er un blob avec les r√©sultats
    const results = document.getElementById('results-content').textContent;
    const blob = new Blob([results], { type: 'application/json' });
    
    // Cr√©er un lien de t√©l√©chargement
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `task_${taskId}_results.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// Nettoyer l'interval quand on quitte la page
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});
</script>

{% endblock %}
