{% extends "base.html" %}
{% block title %}Monitoring de t√¢che{% endblock %}
{% block content %}

<div class="container mt-4">
    <h2>‚ö° Monitoring de t√¢che Celery</h2>
    <p class="text-muted">ID de t√¢che: <code>{{ task_id }}</code></p>
    
    <!-- Statut principal -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 id="task-title">üìä Statut de la t√¢che</h5>
            <div>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshStatus()">
                    üîÑ Actualiser
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="cancelTask()" id="cancel-btn">
                    üõë Annuler
                </button>
            </div>
        </div>
        <div class="card-body">
            
            <!-- Barre de progression -->
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-2">
                    <span id="status-text">Chargement du statut...</span>
                    <span id="progress-text">0%</span>
                </div>
                <div class="progress" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         id="progress-bar" 
                         role="progressbar" 
                         style="width: 0%">
                        0%
                    </div>
                </div>
            </div>
            
            <!-- Informations d√©taill√©es -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card border-info">
                        <div class="card-body">
                            <h6 class="card-title">‚ÑπÔ∏è Informations</h6>
                            <div id="task-info">
                                <p><strong>√âtat:</strong> <span id="task-state" class="badge bg-secondary">PENDING</span></p>
                                <p><strong>Cible:</strong> <span id="task-target">-</span></p>
                                <p><strong>Phase:</strong> <span id="task-phase">-</span></p>
                                <p><strong>Dur√©e:</strong> <span id="task-duration">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-success">
                        <div class="card-body">
                            <h6 class="card-title">‚è∞ Timestamps</h6>
                            <div id="task-timestamps">
                                <p><strong>D√©marrage:</strong> <span id="task-started">-</span></p>
                                <p><strong>Derni√®re MAJ:</strong> <span id="task-updated">-</span></p>
                                <p><strong>Termin√©:</strong> <span id="task-completed">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ‚úÖ R√âSULTATS D√âCOUVERTE R√âSEAU (affich√© seulement si termin√©) -->
            <div id="discovery-results" style="display: none;" class="mt-4">
                <div class="card border-success">
                    <div class="card-header">
                        <h6>üåê R√©sultats de la d√©couverte r√©seau</h6>
                    </div>
                    <div class="card-body" id="discovery-content">
                        <!-- Contenu des r√©sultats de d√©couverte sera inject√© ici -->
                    </div>
                </div>
            </div>
            
            <!-- R√©sultats autres t√¢ches (JSON) -->
            <div id="task-results" style="display: none;" class="mt-4">
                <div class="card border-success">
                    <div class="card-header">
                        <h6>‚úÖ R√©sultats</h6>
                    </div>
                    <div class="card-body">
                        <div id="results-content">
                            <!-- Contenu des r√©sultats sera inject√© ici -->
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-outline-primary" onclick="downloadResults()">
                                üíæ T√©l√©charger les r√©sultats
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Erreurs -->
            <div id="task-errors" style="display: none;" class="mt-4">
                <div class="card border-danger">
                    <div class="card-header">
                        <h6>‚ùå Erreur</h6>
                    </div>
                    <div class="card-body">
                        <div id="error-content" class="text-danger">
                            <!-- Contenu des erreurs sera inject√© ici -->
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- NOUVEAU : Syst√®me d'onglets pour les logs -->
    <div class="card">
        <div class="card-header">
            <h6>üìã Monitoring d√©taill√©</h6>
            <!-- Navigation par onglets -->
            <ul class="nav nav-tabs card-header-tabs mt-2" id="monitoring-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="activity-log-tab" data-bs-toggle="tab" data-bs-target="#activity-log-pane" 
                            type="button" role="tab" aria-controls="activity-log-pane" aria-selected="true">
                        üìù Log des activit√©s
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="raw-commands-tab" data-bs-toggle="tab" data-bs-target="#raw-commands-pane" 
                            type="button" role="tab" aria-controls="raw-commands-pane" aria-selected="false">
                        üíª Commandes brutes
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="system-info-tab" data-bs-toggle="tab" data-bs-target="#system-info-pane" 
                            type="button" role="tab" aria-controls="system-info-pane" aria-selected="false">
                        üîß Infos syst√®me
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <!-- Contenu des onglets -->
            <div class="tab-content" id="monitoring-tab-content">
                
                <!-- Onglet 1: Log des activit√©s -->
                <div class="tab-pane fade show active" id="activity-log-pane" role="tabpanel" aria-labelledby="activity-log-tab">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">üìù Journal d'activit√©</h6>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearActivityLog()">
                                üóëÔ∏è Vider
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportActivityLog()">
                                üíæ Exporter
                            </button>
                        </div>
                    </div>
                    <div id="activity-log" style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace;">
                        <div class="text-muted">En attente du d√©but de la t√¢che...</div>
                    </div>
                </div>
                
                <!-- Onglet 2: Commandes brutes -->
                <div class="tab-pane fade" id="raw-commands-pane" role="tabpanel" aria-labelledby="raw-commands-tab">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">üíª Commandes ex√©cut√©es</h6>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearRawCommands()">
                                üóëÔ∏è Vider
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportRawCommands()">
                                üíæ Exporter
                            </button>
                        </div>
                    </div>
                    <div id="raw-commands" style="max-height: 400px; overflow-y: auto; background-color: #1a1a1a; color: #00ff00; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 14px;">
                        <div class="text-success">$ Waiting for task execution...</div>
                    </div>
                </div>
                
                <!-- Onglet 3: Infos syst√®me -->
                <div class="tab-pane fade" id="system-info-pane" role="tabpanel" aria-labelledby="system-info-tab">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>üîß Informations Celery</h6>
                            <div id="celery-info" class="bg-light p-3 rounded">
                                <div class="text-muted">Chargement des informations Celery...</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>üìä Statistiques</h6>
                            <div id="task-stats" class="bg-light p-3 rounded">
                                <div class="text-muted">Chargement des statistiques...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    
    <!-- Actions rapides -->
    <div class="mt-4">
        <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">üè† Retour Dashboard</a>
        <a href="{{ url_for('tasks.tasks_dashboard') }}" class="btn btn-outline-info">üìä Toutes les t√¢ches</a>
        <a href="http://localhost:5555" target="_blank" class="btn btn-outline-warning">üå∏ Flower</a>
    </div>
</div>

<script>
const taskId = '{{ task_id }}';
let refreshInterval;
let startTime = new Date();
let lastState = 'PENDING';
let rawCommandsLog = [];
let activityLogEntries = [];

// D√©marrer le monitoring automatique
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Monitoring charg√© pour t√¢che:', taskId);
    refreshStatus();
    startAutoRefresh();
    loadSystemInfo();
});

function startAutoRefresh() {
    refreshInterval = setInterval(refreshStatus, 3000); // Toutes les 3 secondes
    console.log('üîÑ Auto-refresh activ√©');
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        console.log('‚èπÔ∏è Auto-refresh arr√™t√©');
    }
}

// ‚úÖ FONCTION MANQUANTE AJOUT√âE
function refreshStatus() {
    console.log('üîÑ Actualisation du statut...');
    
    fetch(`/tasks/api/${taskId}/status`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('üìä Donn√©es re√ßues:', data);
            
            if (data.success !== false) {
                updateUI(data);
            } else {
                console.warn('‚ö†Ô∏è Pas de donn√©es disponibles:', data);
                addLogEntry('‚ö†Ô∏è T√¢che en cours de d√©marrage...', 'info');
            }
            
            // Arr√™ter l'auto-refresh si termin√©
            if (data.unified_state === 'SUCCESS' || data.unified_state === 'FAILURE' || 
                data.state === 'SUCCESS' || data.state === 'FAILURE') {
                stopAutoRefresh();
                addLogEntry('‚úÖ Monitoring termin√© - t√¢che compl√®te', 'info');
            }
        })
        .catch(error => {
            console.error('‚ùå Erreur refresh:', error);
            addLogEntry('‚ùå Erreur de communication: ' + error.message, 'error');
        });
}

function updateUI(data) {
    const state = data.unified_state || data.state || 'PENDING';
    const progress = data.unified_progress || data.progress || 0;
    
    // Mettre √† jour le titre
    document.getElementById('task-title').textContent = `üìä T√¢che ${state}`;
    
    // Mettre √† jour la barre de progression
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    
    progressBar.style.width = `${progress}%`;
    progressBar.textContent = `${progress}%`;
    progressText.textContent = `${progress}%`;
    
    // Couleur de la barre selon l'√©tat
    progressBar.className = 'progress-bar progress-bar-striped';
    if (state === 'SUCCESS') {
        progressBar.classList.add('bg-success');
        progressBar.classList.remove('progress-bar-animated');
    } else if (state === 'FAILURE') {
        progressBar.classList.add('bg-danger');
        progressBar.classList.remove('progress-bar-animated');
    } else if (state === 'PROGRESS') {
        progressBar.classList.add('bg-warning', 'progress-bar-animated');
    } else {
        progressBar.classList.add('bg-info', 'progress-bar-animated');
    }
    
    // Mettre √† jour le statut
    const status = data.unified_status || data.status || '√âtat inconnu';
    document.getElementById('status-text').textContent = status;
    
    // Mettre √† jour le badge d'√©tat
    const stateBadge = document.getElementById('task-state');
    stateBadge.textContent = state;
    stateBadge.className = 'badge';
    
    if (state === 'SUCCESS') {
        stateBadge.classList.add('bg-success');
    } else if (state === 'FAILURE') {
        stateBadge.classList.add('bg-danger');
    } else if (state === 'PROGRESS') {
        stateBadge.classList.add('bg-warning');
    } else {
        stateBadge.classList.add('bg-secondary');
    }
    
    // Mettre √† jour les informations d√©taill√©es
    if (data.meta || data.celery_info) {
        const metaData = data.meta || data.celery_info || {};
        
        if (metaData.target) {
            document.getElementById('task-target').textContent = metaData.target;
        }
        if (metaData.phase) {
            document.getElementById('task-phase').textContent = metaData.phase;
        }
    }
    
    // Calculer la dur√©e
    const duration = Math.floor((new Date() - startTime) / 1000);
    document.getElementById('task-duration').textContent = `${duration}s`;
    
    // Mettre √† jour les timestamps
    document.getElementById('task-updated').textContent = new Date().toLocaleTimeString();
    
    // Ajouter au log si changement d'√©tat
    if (state !== lastState) {
        addLogEntry(`üìä √âtat: ${lastState} ‚Üí ${state}`, 'info');
        lastState = state;
    }
    
    // Ajouter au log les changements de statut
    if (data.unified_status && data.unified_status !== '√âtat inconnu') {
        addLogEntry(`‚ÑπÔ∏è ${data.unified_status}`, 'info');
    }
    
    // NOUVEAU : Capturer les commandes brutes
    if (data.meta && data.meta.phase) {
        addRawCommand(`# Phase: ${data.meta.phase}`);
        
        // Simuler les commandes selon la phase
        if (data.meta.phase === 'D√©couverte r√©seau' && !rawCommandsLog.find(cmd => cmd.includes('nmap -sn'))) {
            addRawCommand(`nmap -sn ${data.meta.target || '172.20.0.1/24'}`);
        } else if (data.meta.phase === 'Scan ports' && !rawCommandsLog.find(cmd => cmd.includes('nmap -p'))) {
            addRawCommand(`nmap -p 21,22,23,25,53,80,443 ${data.meta.target || '172.20.0.1/24'}`);
        } else if (data.meta.phase === 'Service detection' && !rawCommandsLog.find(cmd => cmd.includes('nmap -sV'))) {
            addRawCommand(`nmap -sV ${data.meta.target || '172.20.0.1/24'}`);
        }
    }
    
    // Afficher les r√©sultats si termin√©
    if (state === 'SUCCESS' && data.result) {
        if (isDiscoveryTask(data.result)) {
            showDiscoveryResults(data.result);
        } else {
            showResults(data.result);
        }
    }
    
    // Afficher les erreurs si √©chec
    if (state === 'FAILURE' && (data.error || data.celery_info)) {
        showError(data.error || JSON.stringify(data.celery_info));
    }
}

// NOUVELLES FONCTIONS POUR LES ONGLETS

function addLogEntry(message, type = 'info') {
    const logDiv = document.getElementById('activity-log');
    const timestamp = new Date().toLocaleTimeString();
    
    const entry = document.createElement('div');
    entry.className = `mb-1 text-${type === 'error' ? 'danger' : 'dark'}`;
    entry.innerHTML = `<small class="text-muted">${timestamp}</small> ${message}`;
    
    // Ajouter √† la liste pour export
    activityLogEntries.push({
        timestamp,
        message,
        type
    });
    
    logDiv.appendChild(entry);
    logDiv.scrollTop = logDiv.scrollHeight; // Auto-scroll
}

function addRawCommand(command) {
    const rawDiv = document.getElementById('raw-commands');
    const timestamp = new Date().toLocaleTimeString();
    
    // √âviter les doublons
    if (rawCommandsLog.includes(command)) {
        return;
    }
    
    rawCommandsLog.push(command);
    
    const entry = document.createElement('div');
    entry.className = 'mb-1';
    
    if (command.startsWith('#')) {
        // Commentaire
        entry.innerHTML = `<span class="text-info">[${timestamp}] ${command}</span>`;
    } else {
        // Commande
        entry.innerHTML = `<span class="text-warning">[${timestamp}]</span> <span class="text-success">$ ${command}</span>`;
    }
    
    rawDiv.appendChild(entry);
    rawDiv.scrollTop = rawDiv.scrollHeight; // Auto-scroll
}

function clearActivityLog() {
    if (confirm('Voulez-vous vraiment vider le log des activit√©s ?')) {
        document.getElementById('activity-log').innerHTML = '<div class="text-muted">Log vid√© par l\'utilisateur</div>';
        activityLogEntries = [];
        addLogEntry('üóëÔ∏è Log des activit√©s vid√©', 'info');
    }
}

function clearRawCommands() {
    if (confirm('Voulez-vous vraiment vider les commandes brutes ?')) {
        document.getElementById('raw-commands').innerHTML = '<div class="text-success">$ Log vid√© par l\'utilisateur</div>';
        rawCommandsLog = [];
    }
}

function exportActivityLog() {
    const content = activityLogEntries.map(entry => 
        `[${entry.timestamp}] ${entry.message}`
    ).join('\n');
    
    downloadTextFile(content, `activity-log-${taskId}.txt`);
}

function exportRawCommands() {
    const content = rawCommandsLog.map((cmd, index) => 
        `${index + 1}. ${cmd}`
    ).join('\n');
    
    downloadTextFile(content, `raw-commands-${taskId}.txt`);
}

function downloadTextFile(content, filename) {
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}

function loadSystemInfo() {
    // Charger les infos Celery
    fetch('/tasks/api/real-stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('celery-info').innerHTML = `
                    <p><strong>Workers actifs:</strong> ${data.stats.workers || 0}</p>
                    <p><strong>T√¢ches actives:</strong> ${data.stats.active || 0}</p>
                    <p><strong>T√¢ches en attente:</strong> ${data.stats.scheduled || 0}</p>
                `;
                
                document.getElementById('task-stats').innerHTML = `
                    <p><strong>Termin√©es:</strong> ${data.stats.completed || 0}</p>
                    <p><strong>√âchou√©es:</strong> ${data.stats.failed || 0}</p>
                    <p><strong>Total:</strong> ${(data.stats.completed || 0) + (data.stats.failed || 0)}</p>
                `;
            }
        })
        .catch(error => {
            document.getElementById('celery-info').innerHTML = '<div class="text-danger">Erreur de chargement</div>';
            document.getElementById('task-stats').innerHTML = '<div class="text-danger">Erreur de chargement</div>';
        });
}

function isDiscoveryTask(result) {
    return result && 
           result.result_data && 
           (result.result_data.summary || result.result_data.hosts || result.result_data.module === 'D√©couverte R√©seau');
}

function showDiscoveryResults(result) {
    const discoveryDiv = document.getElementById('discovery-results');
    const contentDiv = document.getElementById('discovery-content');
    
    const resultData = result.result_data;
    
    if (resultData && resultData.success) {
        let html = `
            <div class="alert alert-success">
                <h6>‚úÖ D√©couverte termin√©e avec succ√®s !</h6>
                <p><strong>üéØ R√©seau :</strong> ${resultData.target}</p>
            </div>
        `;
        
        // R√©sum√© avec cartes
        if (resultData.summary) {
            html += `
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center border-primary">
                            <div class="card-body">
                                <h5 class="card-title text-primary">${resultData.summary.total_hosts_found || 0}</h5>
                                <p class="card-text">üåê H√¥tes trouv√©s</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-success">
                            <div class="card-body">
                                <h5 class="card-title text-success">${resultData.summary.hosts_with_open_ports || 0}</h5>
                                <p class="card-text">üîì Avec ports ouverts</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-info">
                            <div class="card-body">
                                <h5 class="card-title text-info">${resultData.summary.total_open_ports || 0}</h5>
                                <p class="card-text">üî¢ Ports ouverts total</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-warning">
                            <div class="card-body">
                                <h5 class="card-title text-warning">${(resultData.summary.potential_servers || []).length}</h5>
                                <p class="card-text">üñ•Ô∏è Serveurs d√©tect√©s</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Tableau des h√¥tes d√©taill√©s
        if (resultData.hosts && resultData.hosts.length > 0) {
            html += `
                <h6>üîç D√©tails des h√¥tes :</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>IP</th>
                                <th>Statut</th>
                                <th style="width: 200px;">Ports ouverts</th>
                                <th style="width: 250px;">Services</th>
                                <th style="width: 200px;">OS</th>
                                <th style="width: 300px;">Infos suppl√©mentaires</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            resultData.hosts.forEach(host => {
                html += `
                    <tr>
                        <td><strong>${host.ip}</strong></td>
                        <td>
                            ${host.scan_success ? 
                                '<span class="badge bg-success">Actif</span>' : 
                                '<span class="badge bg-danger">Erreur</span>'
                            }
                        </td>
                        <td>
                            ${host.ports && host.ports.length > 0 ? 
                                `<div style="max-height: 120px; overflow-y: auto;">
                                    ${host.ports.map(port => `<span class="badge bg-light text-dark d-block mb-1">${port.port}</span>`).join('')}
                                </div>` : 
                                '<span class="text-muted">Aucun</span>'
                            }
                        </td>
                        <td>
                            ${host.services && host.services.length > 0 ? 
                                `<div style="max-height: 120px; overflow-y: auto;">
                                    ${host.services.map(service => `<small class="text-info d-block mb-1">${service.version || service.service}</small>`).join('')}
                                </div>` : 
                                '<span class="text-muted">N/A</span>'
                            }
                        </td>
                        <td>
                            ${host.os ? 
                                `<div style="max-height: 120px; overflow-y: auto;">
                                    <small class="text-warning">${host.os}</small>
                                </div>` : 
                                '<span class="text-muted">Non d√©tect√©</span>'
                            }
                        </td>
                        <td>
                            ${host.additional_info && host.additional_info.length > 0 ? 
                                `<div style="max-height: 120px; overflow-y: auto;">
                                    ${host.additional_info.map(info => `<small class="text-primary d-block mb-1">‚Ä¢ ${info}</small>`).join('')}
                                </div>` : 
                                '<span class="text-muted">Aucune</span>'
                            }
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // Serveurs potentiels
        if (resultData.summary && resultData.summary.potential_servers && resultData.summary.potential_servers.length > 0) {
            html += `
                <h6>üñ•Ô∏è Serveurs d√©tect√©s :</h6>
                <div class="row">
            `;
            
            resultData.summary.potential_servers.forEach(server => {
                html += `
                    <div class="col-md-4 mb-2">
                        <div class="card border-warning">
                            <div class="card-body">
                                <h6 class="card-title">${server.ip}</h6>
                                <p class="card-text">
                                    <span class="badge bg-warning text-dark">${server.type}</span><br>
                                    <small>Ports: ${server.ports.join(', ')}</small>
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
            `;
        }
        
        // Ports les plus fr√©quents
        if (resultData.summary && resultData.summary.most_common_ports) {
            html += `
                <h6>üìä Ports les plus fr√©quents :</h6>
                <div class="row mb-3">
            `;
            
            Object.entries(resultData.summary.most_common_ports).forEach(([port, count]) => {
                html += `
                    <div class="col-md-2 mb-2">
                        <div class="card text-center border-info">
                            <div class="card-body py-2">
                                <h6 class="card-title text-info mb-1">${port}</h6>
                                <small class="text-muted">${count} h√¥te(s)</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
            `;
        }
        
        // Boutons d'action
        html += `
            <div class="mt-4">
                <button class="btn btn-outline-primary" onclick="downloadResults()">
                    üíæ T√©l√©charger rapport complet
                </button>
                <button class="btn btn-outline-info" onclick="copyResultsToClipboard()">
                    üìã Copier dans le presse-papier
                </button>
            </div>
        `;
        
        contentDiv.innerHTML = html;
        discoveryDiv.style.display = 'block';
        
        // Ajouter au log
        addLogEntry(`‚úÖ R√©sultats affich√©s: ${resultData.summary?.total_hosts_found || 0} h√¥tes trouv√©s`, 'info');
        
    } else {
        // Affichage d'erreur
        contentDiv.innerHTML = `
            <div class="alert alert-danger">
                <h6>‚ùå Erreur lors de la d√©couverte</h6>
                <p>${resultData?.error || 'Erreur inconnue'}</p>
                <pre class="mt-2 bg-light p-2 rounded">${JSON.stringify(result, null, 2)}</pre>
            </div>
        `;
        discoveryDiv.style.display = 'block';
    }
}

function showResults(result) {
    const resultsDiv = document.getElementById('task-results');
    const contentDiv = document.getElementById('results-content');
    
    // Formatter les r√©sultats selon le type
    let resultHtml = `
        <h6>üìä R√©sultats d√©taill√©s :</h6>
        <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">${JSON.stringify(result, null, 2)}</pre>
    `;
    
    contentDiv.innerHTML = resultHtml;
    resultsDiv.style.display = 'block';
}

function showError(error) {
    const errorDiv = document.getElementById('task-errors');
    const contentDiv = document.getElementById('error-content');
    
    contentDiv.innerHTML = `
        <h6>‚ùå D√©tails de l'erreur :</h6>
        <pre class="bg-danger-subtle p-3 rounded">${error}</pre>
    `;
    errorDiv.style.display = 'block';
}


function copyResultsToClipboard() {
    const resultContent = document.getElementById('discovery-content');
    
    if (!resultContent) {
        alert('Aucun r√©sultat √† copier');
        return;
    }
    
    // Extraire le texte sans HTML
    const textContent = resultContent.innerText;
    
    navigator.clipboard.writeText(textContent).then(() => {
        addLogEntry('üìã R√©sultats copi√©s dans le presse-papier', 'info');
        
        // Notification visuelle temporaire
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '‚úÖ Copi√© !';
        button.disabled = true;
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        }, 2000);
    }).catch(err => {
        console.error('Erreur copie:', err);
        addLogEntry('‚ùå Erreur lors de la copie', 'error');
    });
}

function downloadResults() {
    // Cr√©er un rapport complet
    const timestamp = new Date().toISOString();
    const report = `
RAPPORT DE D√âCOUVERTE R√âSEAU
============================
G√©n√©r√© le: ${timestamp}
ID de t√¢che: ${taskId}

${document.getElementById('discovery-content').innerText}

--- Logs d'activit√© ---
${activityLogEntries.map(entry => `[${entry.timestamp}] ${entry.message}`).join('\n')}

--- Commandes ex√©cut√©es ---
${rawCommandsLog.map((cmd, i) => `${i + 1}. ${cmd}`).join('\n')}
    `.trim();
    
    downloadTextFile(report, `discovery-report-${taskId}.txt`);
}

function cancelTask() {
    if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir annuler cette t√¢che ?')) {
        fetch(`/tasks/api/${taskId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addLogEntry('üõë T√¢che annul√©e par l\'utilisateur', 'info');
                document.getElementById('cancel-btn').disabled = true;
                stopAutoRefresh();
            } else {
                addLogEntry('‚ùå √âchec de l\'annulation: ' + data.error, 'error');
            }
        })
        .catch(error => {
            addLogEntry('‚ùå Erreur annulation: ' + error, 'error');
        });
    }
}

// Nettoyer l'interval quand on quitte la page
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});
</script>



{% endblock %}
                document.getElementById('celery-info').innerHTML = `
                    <p><strong>Workers actifs:</strong> ${data.stats.workers || 0}</p>
                    <p><strong>T√¢ches actives:</strong> ${data.stats.active || 0}</p>
                    <p><strong>T√¢ches en attente:</strong> ${data.stats.scheduled || 0}</p>
                `;
                
                document.getElementById('task-stats').innerHTML = `
                    <p><strong>Termin√©es:</strong> ${data.stats.completed || 0}</p>
                    <p><strong>√âchou√©es:</strong> ${data.stats.failed || 0}</p>
                    <p><strong>Total:</strong> ${(data.stats.completed || 0) + (data.stats.failed || 0)}</p>
                `;
            }
        })
        .catch(error => {
            document.getElementById('celery-info').innerHTML = '<div class="text-danger">Erreur de chargement</div>';
        });
}

// ‚úÖ NOUVELLE FONCTION : D√©tecter si c'est une t√¢che de d√©couverte
function isDiscoveryTask(result) {
    return result && 
           result.result_data && 
           (result.result_data.summary || result.result_data.hosts || result.result_data.module === 'D√©couverte R√©seau');
}

// ‚úÖ NOUVELLE FONCTION : Afficher les r√©sultats de d√©couverte avec le bel affichage
function showDiscoveryResults(result) {
    const discoveryDiv = document.getElementById('discovery-results');
    const contentDiv = document.getElementById('discovery-content');
    
    const resultData = result.result_data;
    
    if (resultData && resultData.success) {
        let html = `
            <div class="alert alert-success">
                <h6>‚úÖ D√©couverte termin√©e avec succ√®s !</h6>
                <p><strong>üéØ R√©seau :</strong> ${resultData.target}</p>
            </div>
        `;
        
        // R√©sum√© avec cartes
        if (resultData.summary) {
            html += `
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center border-primary">
                            <div class="card-body">
                                <h5 class="card-title text-primary">${resultData.summary.total_hosts_found || 0}</h5>
                                <p class="card-text">üåê H√¥tes trouv√©s</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-success">
                            <div class="card-body">
                                <h5 class="card-title text-success">${resultData.summary.hosts_with_open_ports || 0}</h5>
                                <p class="card-text">üîì Avec ports ouverts</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-info">
                            <div class="card-body">
                                <h5 class="card-title text-info">${resultData.summary.total_open_ports || 0}</h5>
                                <p class="card-text">üî¢ Ports ouverts total</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-warning">
                            <div class="card-body">
                                <h5 class="card-title text-warning">${(resultData.summary.potential_servers || []).length}</h5>
                                <p class="card-text">üñ•Ô∏è Serveurs d√©tect√©s</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Tableau des h√¥tes d√©taill√©s
        if (resultData.hosts && resultData.hosts.length > 0) {
            html += `
                <h6>üîç D√©tails des h√¥tes :</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>IP</th>
                                <th>Statut</th>
                                <th style="width: 200px;">Ports ouverts</th>
                                <th style="width: 250px;">Services</th>
                                <th style="width: 200px;">OS</th>
                                <th style="width: 300px;">Infos</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            resultData.hosts.forEach(host => {
                html += `
                    <tr>
                        <td><strong>${host.ip}</strong></td>
                        <td>
                            ${host.scan_success ? 
                                '<span class="badge bg-success">Actif</span>' : 
                                '<span class="badge bg-danger">Erreur</span>'
                            }
                        </td>
                        <td>
                            ${host.ports && host.ports.length > 0 ? 
                                `<div style="max-height: 120px; overflow-y: auto;">
                                    ${host.ports.map(port => `<span class="badge bg-light text-dark d-block mb-1">${port.port}</span>`).join('')}
                                </div>` : 
                                '<span class="text-muted">Aucun</span>'
                            }
                        </td>
                        <td>
                            ${host.services && host.services.length > 0 ? 
                                `<div style="max-height: 120px; overflow-y: auto;">
                                    ${host.services.map(service => `<small class="text-info d-block mb-1">${service.version || service.service}</small>`).join('')}
                                </div>` : 
                                '<span class="text-muted">N/A</span>'
                            }
                        </td>
                        <td>
                            ${host.os ? 
                                `<div style="max-height: 120px; overflow-y: auto;">
                                    <small class="text-warning">${host.os}</small>
                                </div>` : 
                                '<span class="text-muted">Non d√©tect√©</span>'
                            }
                        </td>
                        <td>
                            ${host.additional_info && host.additional_info.length > 0 ? 
                                `<div style="max-height: 120px; overflow-y: auto;">
                                    ${host.additional_info.map(info => `<small class="text-primary d-block mb-1">‚Ä¢ ${info}</small>`).join('')}
                                </div>` : 
                                '<span class="text-muted">Aucune</span>'
                            }
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // Serveurs potentiels
        if (resultData.summary && resultData.summary.potential_servers && resultData.summary.potential_servers.length > 0) {
            html += `
                <h6>üñ•Ô∏è Serveurs d√©tect√©s :</h6>
                <div class="row">
            `;
            
            resultData.summary.potential_servers.forEach(server => {
                html += `
                    <div class="col-md-4 mb-2">
                        <div class="card border-warning">
                            <div class="card-body">
                                <h6 class="card-title">${server.ip}</h6>
                                <p class="card-text">
                                    <span class="badge bg-warning text-dark">${server.type}</span><br>
                                    <small>Ports: ${server.ports.join(', ')}</small>
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
            `;
        }
        
        contentDiv.innerHTML = html;
        discoveryDiv.style.display = 'block';
        
    } else {
        // Affichage d'erreur
        contentDiv.innerHTML = `
            <div class="alert alert-danger">
                <h6>‚ùå Erreur lors de la d√©couverte</h6>
                <p>${resultData.error || 'Erreur inconnue'}</p>
            </div>
        `;
        discoveryDiv.style.display = 'block';
    }
}

function showResults(result) {
    const resultsDiv = document.getElementById('task-results');
    const contentDiv = document.getElementById('results-content');
    
    // Formatter les r√©sultats selon le type
    let resultHtml = '<pre class="bg-light p-3 rounded">' + JSON.stringify(result, null, 2) + '</pre>';
    
    contentDiv.innerHTML = resultHtml;
    resultsDiv.style.display = 'block';
}

function showError(error) {
    const errorDiv = document.getElementById('task-errors');
    const contentDiv = document.getElementById('error-content');
    
    contentDiv.innerHTML = `<pre>${error}</pre>`;
    errorDiv.style.display = 'block';
}

function cancelTask() {
    if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir annuler cette t√¢che ?')) {
        fetch(`/tasks/api/${taskId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
